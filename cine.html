<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala 2 - Cine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @keyframes pulse-custom { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.3; } }
        @keyframes bounce-custom { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes blink-custom { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-custom { animation: pulse-custom 3s ease-in-out infinite; }
        .animate-bounce-custom { animation: bounce-custom 2s ease-in-out infinite; }
        .animate-blink-custom { animation: blink-custom 1s step-start infinite; }
        @keyframes bounce-sala1 { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        /* Cambiado a bounce-sala2 para reflejar la sala de cine */
        .animate-bounce-sala2 { animation: bounce-sala1 1.5s ease-in-out infinite; } 
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    
    <header class="bg-red-950 p-4 shadow-xl sticky top-0 z-10 border-b border-red-800">
        <div class="container mx-auto flex flex-col items-center">
            
            <h1 class="text-xl md:text-3xl font-extrabold text-yellow-400 flex items-center justify-center w-full mb-2">
                <svg class="w-6 h-6 md:w-8 md:h-8 mr-2 text-cyan-400 animate-bounce-sala2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zm-2 16H8V5h8v14zm-3-8h2v2h-2v-2z"></path>
                </svg>
                Sala de Cine
            </h1>
            
            <div class="w-full flex justify-between items-center mb-2 md:mb-4">
                 <div class="flex items-center space-x-4 text-sm md:text-lg font-bold text-white">
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-hand-pointer text-cyan-400 text-lg"></i>
                        <span id="votesRemainingDisplay" class="text-yellow-400">5</span>
                    </div>
                    <span class="text-cyan-400 hidden sm:inline-block">|</span>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-star text-yellow-400 text-lg"></i>
                        <span id="userStarsDisplay" class="text-yellow-400">0</span>
                    </div>
                    <span class="text-cyan-400 hidden sm:inline-block">|</span>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-gem text-teal-400 text-lg"></i>
                        <span id="totalDiamondsDisplay" class="text-yellow-400">0</span>
                    </div>
                 </div>
                 <div class="flex items-center space-x-2 md:space-x-4">
                    <button onclick="openGlobalInfoModal()" class="bg-red-700 hover:bg-red-600 p-2 rounded-full transition-all hover:scale-105">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                    <a href="perfil.html" class="bg-emerald-600 hover:bg-emerald-700 p-2 rounded-full transition-all hover:scale-105" title="Ir a Perfil">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </a>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-4 w-full justify-center">
                <a href="temas.html" class="bg-yellow-500 text-gray-900 hover:bg-yellow-600 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Volver a Temas</a>
            </div>
            
            <p class="text-center text-lg md:text-xl font-medium text-red-300 mt-4 px-4">
                Elige 5 pel√≠culas que m√°s te gusten para competir por el tercer, segundo y primer puesto.
            </p>
        </div>
    </header>
    
    <main class="container mx-auto p-6">
        <section class="mb-12">
            <h2 class="text-4xl font-extrabold text-center mb-8 text-cyan-400 drop-shadow-lg">üèÜ Top 3: Lo m√°s votado üèÜ</h2>
            <div id="top3Container" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
        </section>
        <section>
            <h2 class="text-3xl font-bold text-center mb-8 text-yellow-400">Resto del Ranking</h2>
            <div id="rankingContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
    </main>

    <div id="quizModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-red-900 to-yellow-900 rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto border-2 border-yellow-400 shadow-2xl">
            <div class="sticky top-0 bg-red-900 p-4 flex justify-between items-center border-b border-red-700">
                <h2 class="text-2xl font-bold text-yellow-400" id="quizTitle">Quiz de la Pel√≠cula</h2>
                <button onclick="closeQuizModal()" class="hover:bg-red-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="quizContent" class="p-6 text-white space-y-6">
                </div>
        </div>
    </div>
    
    <div id="voteModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-red-900 to-emerald-900 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto border-2 border-emerald-400 shadow-2xl">
            <div class="sticky top-0 bg-red-900 p-4 flex justify-between items-center border-b border-red-700">
                <h2 class="text-2xl font-bold text-emerald-400" id="voteTitle">Votar por Pel√≠cula</h2>
                <button onclick="closeVoteSelectionModal()" class="hover:bg-red-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 text-white space-y-4">
                <p class="text-lg text-center font-semibold mb-4">Selecciona cu√°ntas estrellas ‚≠ê quieres usar para votar por: <span id="songTitleForVote" class="text-yellow-400 font-bold"></span></p>
                <p class="text-sm text-center text-gray-300">Votos restantes: <span id="currentVotesRemaining" class="text-yellow-400 font-bold">5</span> | Estrellas actuales: <span id="currentUserStars" class="text-yellow-400 font-bold">0</span></p>
                
                <div class="grid grid-cols-2 gap-3" id="starOptionsContainer">
                    </div>
                
                <div id="voteMessage" class="mt-4 text-center text-red-400 font-semibold hidden"></div>

                <div class="flex justify-end pt-4">
                    <button onclick="submitVote()" id="submitVoteButton" class="bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-lg font-bold text-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                        Confirmar Voto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-red-950 p-4 shadow-inner mt-12 border-t border-red-800">
        <div class="container mx-auto flex justify-center items-center">
            <a href="https://youtube.com/@elcanaldealgodecine?si=hHIjTjWCnq2Y3yyB" target="_blank" class="text-red-400 hover:text-red-500 font-semibold flex items-center gap-2 transition-all">
                <svg class="w-8 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21.582,6.186c-0.23-0.814-0.814-1.398-1.628-1.628C18.309,4,12,4,12,4S5.691,4,4.046,4.558C3.232,4.788,2.648,5.372,2.418,6.186C1.86,7.831,1.86,12,1.86,12s0,4.169,0.558,5.814c0.23,0.814,0.814,1.398,1.628,1.628C5.691,20,12,20,12,20s6.309,0,7.954-0.558c0.814-0.23,1.398-0.814,1.628-1.628C22.14,16.169,22.14,12,22.14,12S22.14,7.831,21.582,6.186z M10,15.464V8.536L16,12L10,15.464z"></path>
                </svg>
                Visita nuestro canal de Cine en YouTube
            </a>
        </div>
    </footer>

    <script>
        // --- DATA DE PEL√çCULAS ---
        // HE ADAPTADO LA DATA PARA QUE SEAN PEL√çCULAS DE CINE
        var initialSongs = [
            { id: 1, title: "Pulp Fiction", author: "Quentin Tarantino", year: 1994, genre: "Neo-noir / Crimen", image: "imagenportada/cine_pulpfiction.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/cine_pulpfiction.mp3", description: "Las vidas de dos sicarios, un boxeador, la esposa de un g√°ngster y una pareja de atracadores se entrelazan en cuatro historias de violencia y redenci√≥n.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ 
                { q: "¬øC√≥mo se llama el personaje de Samuel L. Jackson?", a: "Jules Winnfield", d: ["Vincent Vega", "Butch Coolidge", "Marsellus Wallace"] }, 
                { q: "¬øQu√© actor interpreta a Vincent Vega?", a: "John Travolta", d: ["Bruce Willis", "Harvey Keitel", "Tim Roth"] }, 
                { q: "¬øQu√© contiene el malet√≠n que Jules y Vincent deben recuperar?", a: "Nunca se revela (es un MacGuffin)", d: ["Diamantes robados", "El alma de Marsellus Wallace", "Dinero y drogas"] }, 
                { q: "¬øQu√© le da Vincent Vega a Mia Wallace para salvarla de una sobredosis?", a: "Una inyecci√≥n de adrenalina al coraz√≥n", d: ["Una botella de agua", "Un ant√≠doto", "Un caf√© muy cargado"] }, 
                { q: "¬øQu√© plato pide Mia Wallace en el restaurante Jack Rabbit Slim's?", a: "Batido de cinco d√≥lares (Five-Dollar Shake)", d: ["Hamburguesa con queso", "Aros de cebolla", "Filete"] } 
            ] } },
            { id: 2, title: "El Padrino (The Godfather)", author: "Francis Ford Coppola", year: 1972, genre: "Crimen / Drama", image: "imagenportada/cine_padrino.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/cine_padrino.mp3", description: "La cr√≥nica de la familia Corleone, una de las cinco familias que dominan la mafia en Nueva York.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ 
                { q: "¬øC√≥mo se llama el patriarca de la familia Corleone?", a: "Vito Corleone", d: ["Michael Corleone", "Sonny Corleone", "Tom Hagen"] }, 
                { q: "¬øQu√© actor interpreta a Vito Corleone?", a: "Marlon Brando", d: ["Al Pacino", "Robert De Niro", "James Caan"] }, 
                { q: "¬øCu√°l es el famoso 'negocio' que el padrino se niega a hacer y que provoca el conflicto?", a: "El tr√°fico de drogas", d: ["El juego", "La prostituci√≥n", "El alcohol ilegal"] }, 
                { q: "¬øQu√© frase se asocia a menudo con Michael Corleone al final de la saga?", a: "Mant√©n cerca a tus amigos, y a√∫n m√°s cerca a tus enemigos.", d: ["Yo no he hecho nada", "La venganza es un plato que se sirve fr√≠o", "Es solo un negocio"] }, 
                { q: "¬øQu√© objeto deja Sonny Corleone en el coche antes de ser emboscado?", a: "Una naranja", d: ["Un arma", "Un abrigo", "Un peri√≥dico"] } 
            ] } },
            { id: 3, title: "Interestelar (Interstellar)", author: "Christopher Nolan", year: 2014, genre: "Ciencia Ficci√≥n / Aventura", image: "imagenportada/cine_interestelar.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/cine_interestelar.mp3", description: "Un grupo de exploradores viaja a trav√©s de un agujero de gusano para asegurar la supervivencia de la humanidad.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ 
                { q: "¬øCu√°l es el trabajo de Cooper (el protagonista) al comienzo de la pel√≠cula?", a: "Granjero y expiloto de la NASA", d: ["Profesor de f√≠sica", "Mec√°nico", "Soldado"] }, 
                { q: "¬øC√≥mo se llama la hija de Cooper, cuyo nombre significa 'amor'?", a: "Murph", d: ["Amelia", "Brand", "TARS"] }, 
                { q: "¬øQu√© fen√≥meno c√≥smico utilizan para viajar a otras galaxias?", a: "Un agujero de gusano", d: ["Un agujero negro", "Un motor de curvatura", "Un portal estelar"] }, 
                { q: "¬øQu√© concepto se revela como la fuerza que trasciende las dimensiones, seg√∫n la Dra. Brand?", a: "El amor", d: ["La gravedad", "El tiempo", "La esperanza"] }, 
                { q: "¬øCu√°l es el nombre del robot con sentido del humor?", a: "TARS", d: ["CASE", "HAL", "R2-D2"] } 
            ] } },
            { id: 4, title: "Cadena Perpetua (Shawshank Redemption)", author: "Frank Darabont", year: 1994, genre: "Drama", image: "imagenportada/cine_cadena.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/cine_cadena.mp3", description: "Andy Dufresne, un banquero condenado por matar a su esposa, sobrevive y planea su fuga de la prisi√≥n de Shawshank.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ 
                { q: "¬øC√≥mo se llama el protagonista, el banquero?", a: "Andy Dufresne", d: ["Ellis 'Red' Redding", "Warden Norton", "Heywood"] }, 
                { q: "¬øQu√© herramienta usa Andy para cavar el t√∫nel durante casi 20 a√±os?", a: "Un peque√±o martillo de ge√≥logo", d: ["Una cuchara", "Una pala plegable", "Una barra de metal"] }, 
                { q: "¬øQu√© es lo que Andy pide para la biblioteca de la prisi√≥n durante a√±os?", a: "Donaciones de libros", d: ["Dinero", "Un proyector", "Una radio"] }, 
                { q: "¬øQu√© esconde Andy detr√°s del p√≥ster en su celda?", a: "Un agujero", d: ["Su diario", "Un mapa", "Un arma"] }, 
                { q: "¬øD√≥nde encuentra Red el dinero que le dej√≥ Andy?", a: "Bajo un √°rbol cerca de un muro de piedra", d: ["En una caja fuerte", "Enterrado en la playa", "En una carta"] } 
            ] } },
            { id: 5, title: "Alien, el octavo pasajero", author: "Ridley Scott", year: 1979, genre: "Ciencia Ficci√≥n / Terror", image: "imagenportada/cine_alien.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/cine_alien.mp3", description: "La tripulaci√≥n de la nave Nostromo es atacada por una forma de vida extraterrestre letal.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ 
                { q: "¬øCu√°l es el nombre de la hero√≠na y √∫nica superviviente humana de la Nostromo?", a: "Ellen Ripley", d: ["Dallas", "Lambert", "Parker"] }, 
                { q: "¬øCu√°l es la funci√≥n del androide Ash, que traiciona a la tripulaci√≥n?", a: "Oficial cient√≠fico", d: ["Capit√°n", "Ingeniero jefe", "Piloto"] }, 
                { q: "¬øC√≥mo se llama el planeta donde encuentran los huevos alien√≠genas?", a: "Acheron LV-426", d: ["Tatooine", "Marte", "Polo Sur"] }, 
                { q: "¬øEn qu√© parte del cuerpo del tripulante Kane nace el 'Chestburster'?", a: "En su pecho (al romper el estern√≥n)", d: ["En su espalda", "En su est√≥mago", "En su garganta"] }, 
                { q: "¬øCu√°l es el nombre del gato de la tripulaci√≥n?", a: "Jones (o Jonesy)", d: ["Mishi", "Gato", "F√©lix"] } 
            ] } },
            { id: 6, title: "Ciudad de Dios (Cidade de Deus)", author: "Fernando Meirelles", year: 2002, genre: "Drama / Crimen", image: "imagenportada/cine_ciudaddedios.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/cine_ciudaddedios.mp3", description: "La vida en una favela de R√≠o de Janeiro a trav√©s de los ojos de Rocket, un joven que busca ser fot√≥grafo.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ 
                { q: "¬øC√≥mo se llama el barrio marginal de R√≠o de Janeiro donde transcurre la historia?", a: "Cidade de Deus (Ciudad de Dios)", d: ["Rocinha", "Copacabana", "Santa Marta"] }, 
                { q: "¬øC√≥mo se llama el protagonista que quiere ser fot√≥grafo?", a: "Buscap√© (Rocket)", d: ["Dadinho (Li'l Dice)", "Ben√©", "Cabeleira"] }, 
                { q: "¬øQui√©n es el traficante de drogas m√°s violento que domina la favela?", a: "Z√© Pequeno (Li'l Z√©)", d: ["Cabeleira", "Shaggy", "Ben√©"] }, 
                { q: "¬øQu√© le da Buscap√© a Z√© Pequeno que le permite escapar de ser asesinado?", a: "Una foto", d: ["Dinero", "Un arma", "Un coche"] }, 
                { q: "¬øCu√°l es la profesi√≥n que finalmente ayuda al protagonista a dejar la vida del crimen?", a: "Fotograf√≠a", d: ["M√∫sica", "F√∫tbol", "Periodismo"] } 
            ] } },
            { id: 7, title: "E.T. El Extraterrestre", author: "Steven Spielberg", year: 1982, genre: "Ciencia Ficci√≥n / Familiar", image: "imagenportada/cine_et.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/cine_et.mp3", description: "Un ni√±o solitario se hace amigo de un extraterrestre abandonado, y juntos intentan encontrar una forma de volver a casa.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ 
                { q: "¬øC√≥mo se llama el ni√±o que encuentra y protege a E.T.?", a: "Elliott", d: ["Michael", "Greg", "Gary"] }, 
                { q: "¬øQu√© objeto usa E.T. para 'llamar a casa'?", a: "Un dispositivo hecho con chatarra (tel√©fono) y un paraguas", d: ["Un walkie-talkie", "Un ordenador", "Una nave espacial miniatura"] }, 
                { q: "¬øC√≥mo hacen Elliott y E.T. para escapar de los cient√≠ficos en la famosa escena de la bicicleta?", a: "Vuelan por el cielo", d: ["Usan un coche", "Se esconden en el bosque", "E.T. se vuelve invisible"] }, 
                { q: "¬øQu√© es lo que hace brillar el dedo de E.T.?", a: "Su poder curativo", d: ["Una luz de linterna", "Un anillo", "Polvo de hadas"] }, 
                { q: "¬øQu√© frase ic√≥nica dice E.T.?", a: "E.T. tel√©fono... casa.", d: ["Volver√©", "Que la fuerza te acompa√±e", "Houston, tenemos un problema"] } 
            ] } },
            { id: 8, title: "El Viaje de Chihiro", author: "Hayao Miyazaki", year: 2001, genre: "Animaci√≥n / Fantas√≠a", image: "imagenportada/cine_chihiro.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/cine_chihiro.mp3", description: "Una ni√±a de 10 a√±os se aventura en un mundo de esp√≠ritus para salvar a sus padres, que han sido convertidos en cerdos.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ 
                { q: "¬øC√≥mo se llama el chico que ayuda a Chihiro en el mundo de los esp√≠ritus?", a: "Haku", d: ["Kamaji", "Zeniba", "Lin"] }, 
                { q: "¬øEn qu√© son convertidos los padres de Chihiro al comienzo de la pel√≠cula?", a: "Cerdos", d: ["Gallinas", "Cabras", "Perros"] }, 
                { q: "¬øC√≥mo se llama la bruja que dirige la casa de ba√±os?", a: "Yubaba", d: ["Zeniba", "Muta", "El Esp√≠ritu del R√≠o"] }, 
                { q: "¬øQu√© nombre le da Yubaba a Chihiro para quitarle su identidad?", a: "Sen", d: ["Aoi", "Rin", "Kiko"] }, 
                { q: "¬øQu√© criatura sigue a Chihiro y le da una bola de arcilla medicinal?", a: "Sin Cara (No-Face)", d: ["Un Kami", "Un Sapo", "Un esp√≠ritu del holl√≠n"] } 
            ] } },
            { id: 9, title: "Pr√≥ximamente", author: "???", year: "????", genre: "???", image: "", totalStars: 0, comingSoon: true },
            { id: 10, title: "Pr√≥ximamente", author: "???", year: "????", genre: "???", image: "", totalStars: 0, comingSoon: true },
            { id: 11, title: "Pr√≥ximamente", author: "???", year: "????", genre: "???", image: "", totalStars: 0, comingSoon: true },
            { id: 12, title: "Pr√≥ximamente", author: "???", year: "????", genre: "???", image: "", totalStars: 0, comingSoon: true }
        ];

        // --- L√ìGICA DE LA SALA (CINE) ---
        var songs = []; 
        var votesRemaining = 5; 
        var userStars = 0; 
        var totalDiamonds = 0;
        var selectedSongId = null; 
        var selectedSongIdForVote = null; 
        var selectedStarsForVote = 0; 
        
        // Constantes y funciones para la interacci√≥n con perfil.html
        const GLOBAL_SELECTED_SONGS_KEY = 'selectedSongsGlobal';
        const MAX_SELECTED_SONGS = 5;
        const ROOM_IDENTIFIER = 'cine'; // IDENTIFICADOR CLAVE CAMBIADO A 'cine'

        function getGlobalSelectedSongs() {
            return JSON.parse(localStorage.getItem(GLOBAL_SELECTED_SONGS_KEY) || '[]');
        }

        function saveGlobalSelectedSongs(songs) {
            localStorage.setItem(GLOBAL_SELECTED_SONGS_KEY, JSON.stringify(songs));
        }
        
        const VOTE_AMOUNTS = [5, 6, 7, 8, 9, 10]; 
        
        let currentlyPlayingAudio = null;

        function saveAppData() {
            // Se usa un prefijo √∫nico para esta sala para no mezclar datos
            localStorage.setItem('cine_songs', JSON.stringify(songs));
            localStorage.setItem('cine_votesRemaining', votesRemaining); 
            localStorage.setItem('cine_userStars', userStars); 
            localStorage.setItem('cine_totalDiamonds', totalDiamonds);
        }

        function loadAppData() {
            const savedSongs = localStorage.getItem('cine_songs');
            songs = savedSongs ? JSON.parse(savedSongs) : initialSongs;
            votesRemaining = parseInt(localStorage.getItem('cine_votesRemaining') || '5');
            userStars = parseInt(localStorage.getItem('cine_userStars') || '0');
            totalDiamonds = parseInt(localStorage.getItem('cine_totalDiamonds') || '0');

            let diamondRecount = 0;
            songs = songs.map(song => {
                const initial = initialSongs.find(s => s.id === song.id);
                if (typeof song.quizStars === 'undefined') song.quizStars = 0;
                if (song.hasDiamond) diamondRecount++;
                // Asegura que los datos del quiz de inicio se mantengan, por si se reinician
                if (initial) song.contentQuizData = initial.contentQuizData; 
                return song;
            });

            if (totalDiamonds !== diamondRecount) totalDiamonds = diamondRecount;
            updateHeaderDisplays();
        }
        
        // Funci√≥n de selecci√≥n para el perfil (usa el ROOM_IDENTIFIER 'cine')
        function selectSongForProfile(songId) {
            const song = songs.find(s => s.id === songId);
            let globalSelectedSongs = getGlobalSelectedSongs();

            if (!song || !song.listened) {
                if(!song.listened) alert("Debes escuchar la pel√≠cula antes de elegirla.");
                return;
            }
            
            if (globalSelectedSongs.some(s => s.room === ROOM_IDENTIFIER && s.id === songId)) {
                alert(`"${song.title}" ya ha sido elegida.`);
                return;
            }

            if (globalSelectedSongs.length >= MAX_SELECTED_SONGS) {
                alert(`Ya tienes el m√°ximo de ${MAX_SELECTED_SONGS} pel√≠culas elegidas. Elimina una de Perfil para a√±adir otra.`);
                return;
            }

            globalSelectedSongs.push({
                id: song.id, 
                title: song.title, 
                author: song.author, 
                image: song.image,
                room: ROOM_IDENTIFIER, 
                hasDiamond: song.hasDiamond, 
                quizStars: song.quizStars || 0
            });
            
            saveGlobalSelectedSongs(globalSelectedSongs);
            renderRanking(); 
            alert(`¬°"${song.title}" ha sido elegida para tu perfil!`);
        }
        
        // --- FUNCIONES DEL QUIZ (Mantenidas, solo adaptando el contenido) ---
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateQuizQuestions(song) {
            if (!song.contentQuizData || !song.contentQuizData.questions || song.contentQuizData.questions.length < 5) {
                return '<p class="text-red-400">Error: No hay suficientes preguntas para esta pel√≠cula.</p>';
            }
            
            const selectedQuestions = shuffleArray([...song.contentQuizData.questions]).slice(0, 5);
            let quizHtml = '';
            selectedQuestions.forEach((qData, index) => {
                const qNum = index + 1;
                const options = shuffleArray([qData.a, ...qData.d]);
                const optionsHtml = options.map(opt => `
                    <label class="flex items-center p-3 bg-red-700/50 rounded-lg hover:bg-red-600 cursor-pointer">
                        <input type="radio" name="question${qNum}" value="${opt}" class="form-radio h-5 w-5 text-yellow-400">
                        <span class="ml-3 text-lg">${opt}</span>
                    </label>
                `).join('');

                quizHtml += `
                    <div class="p-4 bg-red-800 rounded-xl border border-red-600" data-q-original="${qData.q}" data-q-correct="${qData.a}">
                        <p class="text-xl font-semibold mb-4 text-cyan-300">Pregunta ${qNum}: ${qData.q}</p>
                        <div class="space-y-2">${optionsHtml}</div>
                        <input type="hidden" id="correctAnswer${qNum}" value="${qData.a}">
                    </div>
                `;
            });
            return quizHtml;
        }

        function openQuizModal(id){
            selectedSongId = id;
            const song = songs.find(s => s.id === id);
            if (!song) return;

            document.getElementById('quizTitle').textContent = `Quiz: ¬øQu√© sabes de "${song.title}"?`;
            const quizContent = document.getElementById('quizContent');
            quizContent.innerHTML = generateQuizQuestions(song) + `
                <div class="flex justify-end pt-6">
                    <button onclick="submitQuiz()" class="bg-yellow-600 hover:bg-yellow-700 text-gray-900 px-6 py-3 rounded-lg font-bold text-lg">
                        Finalizar Quiz
                    </button>
                </div>
            `;
            document.getElementById('quizModal').classList.remove('hidden');
        }

        function closeQuizModal() {
            document.getElementById('quizModal').classList.add('hidden');
            selectedSongId = null;
        }

        function submitQuiz() {
            const songIndex = songs.findIndex(s => s.id === selectedSongId);
            if (songIndex === -1) return;

            let correctAnswers = 0;
            const totalQuestions = 5;
            let resultDetailsHtml = '';

            for (let i = 1; i <= totalQuestions; i++) {
                const questionDiv = document.querySelector(`#quizContent > div:nth-child(${i})`);
                if (!questionDiv) continue;
                
                const questionText = questionDiv.getAttribute('data-q-original');
                const selectedInput = document.querySelector(`input[name="question${i}"]:checked`);
                const userAnswer = selectedInput ? selectedInput.value : 'No contestada';
                const correctAnswer = questionDiv.getAttribute('data-q-correct');
                const isCorrect = userAnswer === correctAnswer;
                
                if (isCorrect) correctAnswers++;

                resultDetailsHtml += `
                    <div class="p-3 rounded-lg border ${isCorrect ? 'border-green-500 bg-green-900/50' : 'border-red-500 bg-red-900/50'}">
                        <p class="font-bold text-lg mb-1 text-cyan-300">P. ${i}: ${questionText}</p>
                        <p class="text-sm">Tu Respuesta: <span class="${isCorrect ? 'text-green-300' : 'text-red-300 font-bold'}">${userAnswer} ${isCorrect ? '‚úÖ' : '‚ùå'}</span></p>
                        ${!isCorrect ? `<p class="text-sm">Correcta: <span class="text-yellow-300 font-bold">${correctAnswer}</span></p>` : ''}
                    </div>
                `;
            }

            let starsGained = correctAnswers * 5;
            let resultMessage = '';

            if (correctAnswers === totalQuestions) {
                starsGained += 10; // Bonus
                if (!songs[songIndex].hasDiamond) {
                    songs[songIndex].hasDiamond = true;
                    totalDiamonds++;
                }
                resultMessage = `<p class="font-bold text-cyan-300 mt-2 text-xl">¬°PERFECTO! +10 Estrellas de bonificaci√≥n. ¬°Has ganado un üíé!</p>`;
            } else {
                 resultMessage = `<p class="font-bold text-cyan-300 mt-2">¬°Sigue practicando para mejorar!</p>`;
            }

            songs[songIndex].quizStars = starsGained;
            userStars += starsGained;
            songs[songIndex].unlocked = true; 
            
            const quizContent = document.getElementById('quizContent');
            quizContent.innerHTML = `
                <div class="text-center p-6 bg-red-700 rounded-xl mb-4">
                    <h3 class="text-3xl font-bold mb-4">¬°Resultado!</h3>
                    <p class="text-2xl font-semibold text-yellow-400">Respuestas Correctas: ${correctAnswers} de ${totalQuestions}</p>
                    <p class="text-xl mt-4 text-cyan-400">Estrellas ganadas: <span class="font-bold text-3xl">${starsGained}</span> ‚≠ê</p>
                    ${resultMessage}
                </div>
                <h4 class="text-2xl font-bold text-yellow-400 mb-3 border-b border-yellow-400 pb-2">Detalle de Respuestas</h4>
                <div class="space-y-3">${resultDetailsHtml}</div>
                <div class="flex justify-end pt-4">
                    <button onclick="closeQuizModal()" class="bg-red-500 hover:bg-red-600 px-6 py-3 rounded-lg font-bold text-lg">Cerrar</button>
                </div>
            `;

            saveAppData();
            renderRanking();
            updateHeaderDisplays();
        }

        // --- FUNCIONES DE AUDIO --- (Mantenidas, adaptando IDs y nombres)
        
        function playAudio(songId) {
            const audioPlayer = document.getElementById(`audioPlayer${songId}`);
            if (!audioPlayer) return;

            if (audioPlayer.paused) {
                if (currentlyPlayingAudio && currentlyPlayingAudio !== audioPlayer) {
                    currentlyPlayingAudio.pause();
                    const previousId = parseInt(currentlyPlayingAudio.id.replace('audioPlayer', ''));
                    resetPlayButton(previousId);
                }
                audioPlayer.play().catch(error => {
                    console.error("Error al intentar reproducir audio:", error);
                    resetPlayButton(songId); 
                });
                markAsListened(songId);
                updatePlayButton(songId, true);
                currentlyPlayingAudio = audioPlayer;
            } else {
                audioPlayer.pause();
                updatePlayButton(songId, false);
                currentlyPlayingAudio = null;
            }
        }

        function stopAudio(songId) {
            const audioPlayer = document.getElementById(`audioPlayer${songId}`);
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                updatePlayButton(songId, false);
                if (currentlyPlayingAudio === audioPlayer) {
                    currentlyPlayingAudio = null;
                }
            }
        }
        
        function updatePlayButton(songId, isPlaying) {
             const playButton = document.getElementById(`playButton${songId}`);
             const stopButton = document.getElementById(`stopButton${songId}`);
             const listeningText = document.getElementById(`listeningText${songId}`);
             if (playButton && stopButton && listeningText) {
                 if (isPlaying) {
                    playButton.innerHTML = '<i class="fas fa-pause text-xl"></i>';
                    stopButton.classList.remove('hidden');
                    listeningText.classList.remove('hidden');
                 } else {
                    playButton.innerHTML = '<i class="fas fa-play text-xl"></i>';
                    stopButton.classList.add('hidden');
                    listeningText.classList.add('hidden');
                 }
             }
        }

        function resetPlayButton(songId) {
             updatePlayButton(songId, false);
             if (currentlyPlayingAudio && currentlyPlayingAudio.id === `audioPlayer${songId}`) {
                 currentlyPlayingAudio = null;
             }
             renderRanking();
        }

        function markAsListened(songId) {
            const song = songs.find(s => s.id === songId);
            if(song && !song.listened) {
                song.listened = true;
                saveAppData();
            }
        }
        
        // --- FUNCIONES DE VOTO (Mantenidas) ---

        function openVoteSelectionModal(id) {
            selectedSongIdForVote = id;
            selectedStarsForVote = 0;
            const song = songs.find(s => s.id === id);
            if (!song) return;

            document.getElementById('songTitleForVote').textContent = `"${song.title}"`;
            document.getElementById('currentVotesRemaining').textContent = votesRemaining;
            document.getElementById('currentUserStars').textContent = userStars;
            document.getElementById('voteMessage').classList.add('hidden');
            document.getElementById('submitVoteButton').disabled = true;

            const starOptionsContainer = document.getElementById('starOptionsContainer');
            starOptionsContainer.innerHTML = '';

            VOTE_AMOUNTS.forEach(stars => {
                const canAfford = userStars >= stars;
                const disabledClass = !canAfford ? 'bg-gray-700/50 cursor-not-allowed opacity-50' : 'bg-emerald-700/50 hover:bg-emerald-600 cursor-pointer';
                const label = document.createElement('label');
                label.className = `flex items-center justify-center p-3 rounded-lg transition-all border border-emerald-500 ${disabledClass}`;
                label.innerHTML = `
                    <input type="radio" name="voteStars" value="${stars}" class="hidden" onchange="handleStarSelection(${stars})" ${!canAfford ? 'disabled' : ''}>
                    <span class="text-xl font-bold flex items-center">
                        ${stars} <i class="fas fa-star ml-2 text-yellow-400"></i>
                    </span>
                `;
                starOptionsContainer.appendChild(label);
            });

            document.getElementById('voteModal').classList.remove('hidden');
        }

        function closeVoteSelectionModal() {
            document.getElementById('voteModal').classList.add('hidden');
            selectedSongIdForVote = null;
            selectedStarsForVote = 0;
        }

        function handleStarSelection(stars) {
            selectedStarsForVote = stars;
            const submitButton = document.getElementById('submitVoteButton');
            const message = document.getElementById('voteMessage');

            if (votesRemaining <= 0) {
                message.textContent = "No tienes votos restantes.";
                message.classList.remove('hidden');
                submitButton.disabled = true;
            } else if (userStars < selectedStarsForVote) {
                message.textContent = `Necesitas ${selectedStarsForVote} ‚≠ê para votar con esta opci√≥n.`;
                message.classList.remove('hidden');
                submitButton.disabled = true;
            } else {
                message.classList.add('hidden');
                submitButton.disabled = false;
            }
        }

        function submitVote() {
            if (votesRemaining <= 0) {
                alert("¬°No tienes votos restantes!"); return;
            }
            if (selectedStarsForVote === 0 || userStars < selectedStarsForVote) {
                alert("Por favor, selecciona una cantidad de estrellas v√°lida para votar."); return;
            }
            const songIndex = songs.findIndex(s => s.id === selectedSongIdForVote);
            if (songIndex === -1) return;
            votesRemaining--;
            userStars -= selectedStarsForVote;
            songs[songIndex].totalStars += selectedStarsForVote;
            alert(`¬°Voto exitoso! Usaste ${selectedStarsForVote} ‚≠ê para votar por "${songs[songIndex].title}".`);
            saveAppData();
            updateHeaderDisplays();
            renderRanking();
            closeVoteSelectionModal();
        }
        
        // --- RENDERIZADO ---

        function createSongCard(song, position, isTop3 = false) {
            if (song.comingSoon) {
                return `
                    <div class="bg-gray-800 border border-dashed border-gray-600 rounded-xl overflow-hidden shadow-lg relative flex flex-col items-center justify-center p-4 min-h-[500px] animate-pulse">
                        <div class="text-center">
                            <i class="fas fa-lock text-6xl text-gray-500 mb-4"></i>
                            <h3 class="text-3xl font-bold mb-2 text-red-500">Pr√≥ximamente</h3>
                            <p class="text-gray-400">Nuevo contenido disponible la pr√≥xima semana.</p>
                        </div>
                    </div>`;
            }
            
            // MODIFICACI√ìN: Cambiar el icono de estrella por el de mano
            const starIcon = '<i class="fas fa-hand-pointer text-cyan-400"></i>';
            // FIN MODIFICACI√ìN
            
            const defaultImage = song.image || 'imagenportada/default.png'; 
            const badgeClass = isTop3 ? (position === 1 ? 'bg-red-600' : (position === 2 ? 'bg-gray-400' : 'bg-amber-700')) : 'bg-red-600';
            const diamondIcon = song.hasDiamond ? '<span class="ml-2 text-xl align-middle" title="¬°Quiz Perfecto!">üíé</span>' : '';
            
            const quizStarsBadge = (song.quizStars && song.quizStars > 0) ? `
                <div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full shadow-lg flex items-center gap-1 z-10">
                    <span>${song.quizStars}</span><i class="fas fa-star text-xs"></i>
                </div>` : '';

            const quizButton = !song.unlocked ? `<button onclick="openQuizModal(${song.id})" class="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-gray-900 py-2 rounded-lg font-bold">HACER QUIZ</button>` : '';
            
            const isSelected = getGlobalSelectedSongs().some(s => s.room === ROOM_IDENTIFIER && s.id === song.id);
            const selectButtonClass = song.listened ? (isSelected ? 'bg-gray-500 cursor-not-allowed' : 'bg-cyan-600 hover:bg-cyan-700') : 'bg-gray-500 cursor-not-allowed';
            const selectButtonAction = song.listened && !isSelected ? `onclick="selectSongForProfile(${song.id})"` : 'disabled';

            return `
                <div class="bg-gray-800 border border-gray-700 rounded-xl overflow-hidden shadow-lg relative flex flex-col">
                    ${quizStarsBadge}
                    <div class="absolute top-0 left-0 ${badgeClass} text-white font-black text-lg p-2 rounded-br-lg z-10">${position}</div>
                    <div class="h-48 w-full bg-cover bg-center" style="background-image: url('${defaultImage}')"></div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-2xl font-bold mb-2 text-cyan-400 flex items-center">${song.title} ${diamondIcon}</h3>
                        
                        <div class="mt-1 mb-4 flex items-center justify-start space-x-4">
                            <button onclick="playAudio(${song.id})" id="playButton${song.id}" class="bg-red-500 hover:bg-red-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all hover:scale-105" title="Escuchar">
                                <i class="fas fa-play text-xl"></i>
                            </button>
                            <button onclick="stopAudio(${song.id})" id="stopButton${song.id}" class="hidden bg-gray-500 hover:bg-gray-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all hover:scale-105" title="Detener">
                                <i class="fas fa-stop text-xl"></i>
                            </button>
                            <span id="listeningText${song.id}" class="text-red-400 font-semibold hidden">Escuchando...</span>
                        </div>
                        <audio id="audioPlayer${song.id}" src="${song.localAudioUrl}" onended="resetPlayButton(${song.id})" hidden></audio>
                        <p class="text-sm text-gray-400 mb-4">${song.description}</p>
                        <div class="border-t border-red-700 pt-3 mb-4 space-y-1">
                            <p>Director: <span class="font-semibold text-cyan-400">${song.author}</span></p>
                            <p>A√±o: <span class="font-semibold text-yellow-400">${song.year}</span></p>
                            <p>G√©nero: <span class="font-semibold text-yellow-400">${song.genre}</span></p>
                            ${quizButton}
                        </div>
                        <div class="mt-auto pt-3 border-t border-red-700 flex items-center justify-between">
                            <div class="flex items-center space-x-1 text-yellow-400 font-bold text-lg">${starIcon}<span>${song.totalStars}</span></div>
                            <div class="flex items-center space-x-2">
                                <button onclick="openVoteSelectionModal(${song.id})" class="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg font-bold">Votar</button>
                                <button ${selectButtonAction} class="${selectButtonClass} px-3 py-2 rounded-lg font-bold text-sm">${isSelected ? 'Elegida' : 'Elegir'}</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        
        function updateHeaderDisplays() {
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            document.getElementById('userStarsDisplay').textContent = userStars;
            document.getElementById('totalDiamondsDisplay').textContent = totalDiamonds;
            if (document.getElementById('currentVotesRemaining')) {
                document.getElementById('currentVotesRemaining').textContent = votesRemaining;
            }
            if (document.getElementById('currentUserStars')) {
                document.getElementById('currentUserStars').textContent = userStars;
            }
        }

        function renderRanking() {
            songs.sort((a, b) => b.totalStars - a.totalStars);
            const top3 = document.getElementById('top3Container');
            const ranking = document.getElementById('rankingContainer');
            top3.innerHTML = '';
            ranking.innerHTML = '';
            
            const regularSongs = songs.filter(s => !s.comingSoon);
            const comingSoonSongs = songs.filter(s => s.comingSoon);
            
            regularSongs.slice(0, 3).forEach((s, i) => top3.innerHTML += createSongCard(s, i + 1, true));
            regularSongs.slice(3).forEach((s, i) => ranking.innerHTML += createSongCard(s, i + 4, false));
            
            comingSoonSongs.forEach(s => ranking.innerHTML += createSongCard(s));
        }

        window.onload = function() {
            loadAppData();
            renderRanking();
        };
        
        function openGlobalInfoModal() { 
             alert("Mec√°nica de Votaci√≥n:\n\n* Cada usuario dispone de 5 votos semanales.\n* El voto se realiza gastando 5, 6, 7, 8, 9 o 10 estrellas.\n* Solo se puede votar con una cantidad igual o menor a las estrellas acumuladas.\n\nMec√°nica de Quiz y Estrellas:\n\n* **Moneda (Estrellas):** Se ganan **5 estrellas** por cada pregunta acertada.\n* **Bonificaci√≥n:** Se ganan **10 estrellas m√°s de bonificaci√≥n** si aciertas las 5 preguntas.\n* **Diamante üíé:** Se gana un **diamante para esa pel√≠cula** al contestar todas las preguntas (las 5) bien."); 
        }
    </script>
</body>

</html>
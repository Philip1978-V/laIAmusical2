<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Cine üé¨</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 

<style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f8f8;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            color: #A0522D;
            text-align: center;
            border-bottom: 2px solid #A0522D;
            padding-bottom: 10px;
        }
        
        /* Contenedor para los enlaces de cabecera */
        .header-links {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-link { 
            display: inline-block; 
            text-decoration: none; 
            color: #007bff; 
            font-weight: bold;
        }

        /* ESTILO DEL NUEVO BOT√ìN A TEMAS.HTML */
        .temas-btn {
            background-color: #BEF264; /* Verde/amarillento */
            color: #1a1a1a;
            padding: 8px 12px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            border: 1px solid #a7e555;
            transition: background-color 0.2s;
        }

        .temas-btn:hover {
            background-color: #d2f99a; 
        }

        /* --- Estilos para la Lista de Canciones/Cartas --- */
        #lista-entradas {
            padding: 1px 0; 
        }

        .entrada-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            margin: 5px 0;
            border-bottom: 1px solid #eee; 
            cursor: default; 
            background-color: #fff;
            transition: background-color 0.2s;
        }
        .entrada-item:hover {
            background-color: #f7f7f7;
        }
        .titulo-autor {
            flex-grow: 1;
            margin-right: 15px; 
            min-width: 250px;
        }
        .titulo {
            font-weight: bold;
            color: #333;
        }
        .autor {
            font-size: 0.9em;
            color: #666;
        }
        /* Nuevo estilo para la Obra Original (Cine) */
        .original-obra {
            font-size: 0.85em;
            color: #4682B4; /* Tono azul/gris para el cine */
            margin-top: 2px;
            font-style: italic;
        }

        /* --- Controles de Audio y Compra --- */
        .controles-audio {
            display: flex;
            gap: 10px;
        }
        audio { display: none; }
        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            font-size: 1.2em;
            color: #A0522D;
            transition: color 0.2s;
        }
        .control-btn:hover {
            color: #D2B48C;
        }
        
        .controles-compra {
            display: flex;
            gap: 5px;
            margin-left: 15px;
        }
        
        .buy-btn, .lyrics-btn {
            background: #D2B48C; 
            color: #333;
            border: none;
            padding: 8px 10px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap; 
            font-weight: bold;
            display: flex; 
            align-items: center; 
            gap: 4px; 
        }
        .lyrics-btn {
            background: #A0522D; 
            color: white;
        }
        .buy-btn:hover:not(:disabled), .lyrics-btn:hover:not(:disabled) {
            opacity: 0.9;
        }
        .buy-btn:disabled, .lyrics-btn:disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* --- Estilos para la ventana modal --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        #modal-title {
            color: #A0522D;
            margin-top: 0;
        }
        #modal-message {
            margin-bottom: 20px;
            color: #666;
            font-weight: bold;
        }
        .modal-buttons {
            text-align: right;
        }
        .modal-btn {
            background-color: #A0522D;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .modal-btn:hover {
            background-color: #8b4513;
        }

        /* --- Media Queries para responsividad --- */
        @media (max-width: 600px) {
            .entrada-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .titulo-autor {
                margin-right: 0;
                margin-bottom: 10px;
                min-width: 100%;
            }
            .controles-audio, .controles-compra {
                margin-left: 0;
                width: 100%;
                justify-content: flex-start;
            }
        }
</style>
</head>
<body>

<div class="container">
    <div class="header-links">
        <a href="biblioteca.html" class="back-link">‚Üê Volver a la Biblioteca Principal</a>
        <a href="temas.html" class="temas-btn">Volver a Temas</a>
    </div>

    <h1>Sala de Cine üé¨ (Orden Alfab√©tico)</h1>
    <p>La lista est√° ordenada alfab√©ticamente por t√≠tulo. Usa el rat√≥n para desplazar la vista r√°pidamente a la deseada.</p>

    <div id="lista-entradas">
        </div>

    <div id="compraModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modal-title"></h2>
            <p id="modal-message"></p>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeModal()">Cancelar</button>
                <button class="modal-btn" id="confirmButton">Confirmar Compra</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONSTANTES ---
    const ARCHIVO_SALA = "sala-cine.html"; // ACTUALIZADO para la Sala de Cine
    const CLAVE_LOCAL = "bibliotecaData";
    // Claves globales de Perfil.html
    const GLOBAL_COINS_KEY = 'totalCoins';
    const GLOBAL_SELECTED_SONGS_KEY = 'selectedSongsGlobal'; 
    // Costos de Compra (Actualizados)
    const CARD_COST = 500; // Costo de compra de carta: 500
    const LYRICS_COST = 50; 

    // --- Funciones de Almacenamiento Global (tomadas de Perfil.html) ---
    function getGlobalCoins() {
        return parseInt(localStorage.getItem(GLOBAL_COINS_KEY) || '0', 10);
    }
    function saveGlobalCoins(coins) {
        localStorage.setItem(GLOBAL_COINS_KEY, coins);
    }
    function getSelectedSongs() {
        try {
            return JSON.parse(localStorage.getItem(GLOBAL_SELECTED_SONGS_KEY) || '[]');
        } catch (e) {
            console.error("Error parsing selected songs from localStorage", e);
            return [];
        }
    }
    function saveSelectedSongs(songs) {
        localStorage.setItem(GLOBAL_SELECTED_SONGS_KEY, JSON.stringify(songs));
    }
    function isCardOwned(title, author, sala) {
        const selectedSongs = getSelectedSongs();
        return selectedSongs.some(song => song.titulo === title && song.autor === author && song.sala === sala);
    }

    // --- L√ìGICA DE LA MODAL ---
    let pendingAction = null; 

    function openModal(title, message, actionCallback) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-message').innerText = message;
        
        // Almacenar la acci√≥n pendiente y configurar el bot√≥n de confirmaci√≥n
        pendingAction = actionCallback;
        document.getElementById('confirmButton').onclick = () => {
            if (pendingAction) {
                pendingAction();
                closeModal();
            }
        };

        document.getElementById('compraModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('compraModal').style.display = 'none';
        pendingAction = null; 
    }

    // Funci√≥n global para cerrar modal si se hace clic fuera
    window.onclick = function(event) {
        const modal = document.getElementById('compraModal');
        if (event.target == modal) {
            closeModal();
        }
    }

    // --- FUNCIONES DE COMPRA ---

    function buyCard(index, cost) {
        const todosLosDatos = inicializarDatos();
        const entradasDeSala = todosLosDatos.filter(d => d.sala === ARCHIVO_SALA).sort((a, b) => a.titulo.localeCompare(b.titulo));
        const song = entradasDeSala[index];

        if (!song) {
            alert("Error: Carta no encontrada.");
            return;
        }
        
        // Comprobar si ya la tiene
        if (isCardOwned(song.titulo, song.autor, song.sala)) {
            alert(`Ya tienes la carta "${song.titulo}" en tu Perfil.`);
            return;
        }

        // Abrir modal de confirmaci√≥n
        const title = "Confirmar Compra de Carta";
        const message = `¬øEst√°s seguro de que quieres comprar la carta "${song.titulo}" de ${song.autor} por ${cost} monedas?`;
        
        openModal(title, message, () => {
            let currentCoins = getGlobalCoins();
            if (currentCoins < cost) {
                alert(`Monedas insuficientes. Necesitas ${cost} monedas.`);
                return;
            }
            
            // 1. Restar monedas
            const newCoins = currentCoins - cost;
            saveGlobalCoins(newCoins);

            // 2. A√±adir al perfil (almacenamiento global)
            const selectedSongs = getSelectedSongs();
            selectedSongs.push({
                titulo: song.titulo,
                autor: song.autor,
                sala: song.sala,
                audioUrl: song.audioUrl 
            });
            saveSelectedSongs(selectedSongs);

            // 3. Confirmar y recargar
            alert(`¬°Compra exitosa! Se han restado ${cost} monedas. La carta "${song.titulo}" ha sido a√±adida a tu Perfil. ¬°Ve a Perfil para gestionarla!`);
            cargarEntradas();
        });
    }

    function buyLyrics(index, cost) {
        let currentCoins = getGlobalCoins();
        if (currentCoins < cost) {
            alert(`Monedas insuficientes. Necesitas ${cost} monedas para descargar las letras.`);
            return;
        }
        
        const todosLosDatos = inicializarDatos();
        const entradasDeSala = todosLosDatos.filter(d => d.sala === ARCHIVO_SALA).sort((a, b) => a.titulo.localeCompare(b.titulo));
        const song = entradasDeSala[index];

        if (!song) {
            alert("Error: Carta no encontrada.");
            return;
        }

        // Abrir modal de confirmaci√≥n
        const title = "Confirmar Compra de Letras";
        const message = `¬øEst√°s seguro de que quieres comprar las letras de "${song.titulo}" por ${cost} monedas?`;
        
        openModal(title, message, () => {
            // 1. Restar monedas
            const newCoins = currentCoins - cost;
            saveGlobalCoins(newCoins);

            // 2. Simular la acci√≥n/confirmar la compra
            alert(`¬°Compra de letras exitosa! Se han restado ${cost} monedas. Ahora tienes acceso a las letras de "${song.titulo}". (En un entorno real, aqu√≠ se iniciar√≠a la descarga o se dar√≠a el link).`);
            cargarEntradas();
        });
    }

    // --- LISTADO BASE Y L√ìGICA DE CARGA ---
    const entradasBase = [
        { titulo: "1,21 gigabatios", autor: "Robert Zemeckis", sala: ARCHIVO_SALA, audioUrl: "audio/cine_121gigabatios.mp3", originalObra: "Regreso al Futuro" },
        { titulo: "¬øUn Cr√≠o? Ya Soy un Hombre", autor: "Fernando Meirelles", sala: ARCHIVO_SALA, audioUrl: "audio/cine_uncrio.mp3", originalObra: "Ciudad de Dios" },
        { titulo: "Ciudad de ceniza y de Ne√≥n", autor: "Ridley Scott", sala: ARCHIVO_SALA, audioUrl: "audio/cine_ciudadceniza.mp3", originalObra: "Blade Runner" },
        { titulo: "Deber√≠a estar en un museo", autor: "Steven Spielberg", sala: ARCHIVO_SALA, audioUrl: "audio/cine_museo.mp3", originalObra: "Indiana Jones y la √öltima Cruzada" },
        { titulo: "El elegido", autor: "Hermanas Wachowski", sala: ARCHIVO_SALA, audioUrl: "audio/cine_elegido.mp3", originalObra: "The Matrix" },
        { titulo: "El malet√≠n y el pasaje", autor: "Quentin Tarantino", sala: ARCHIVO_SALA, audioUrl: "audio/cine_pulpfiction.mp3", originalObra: "Pulp Fiction" },
        { titulo: "El Ada azul y mil a√±os", autor: "Steven Spielberg", sala: ARCHIVO_SALA, audioUrl: "audio/cine_adaazul.mp3", originalObra: "A.I. Inteligencia Artificial" },
        { titulo: "Houston tenemos un problema", autor: "Ron Howard", sala: ARCHIVO_SALA, audioUrl: "audio/cine_houston.mp3", originalObra: "Apollo 13" },
        { titulo: "identidad borrada", autor: "Varios Directores", sala: ARCHIVO_SALA, audioUrl: "audio/cine_identidad.mp3", originalObra: "Bourne Identity" },
        { titulo: "La Conexi√≥n Cuantificable", autor: "Christopher Nolan", sala: ARCHIVO_SALA, audioUrl: "audio/cine_conexion.mp3", originalObra: "Interstellar" },
        { titulo: "La isla Nublar", autor: "Steven Spielberg", sala: ARCHIVO_SALA, audioUrl: "audio/cine_nublar.mp3", originalObra: "Parque Jur√°sico" },
        { titulo: "La oferta irrechazable", autor: "Francis Ford Coppola", sala: ARCHIVO_SALA, audioUrl: "audio/cine_oferta.mp3", originalObra: "El Padrino" },
        { titulo: "La √∫ltima superviviente", autor: "Ridley Scott", sala: ARCHIVO_SALA, audioUrl: "audio/cine_superviviente.mp3", originalObra: "Alien: El Octavo Pasajero" },
        { titulo: "la canci√≥n de la corona y el invierno", autor: "D. & D. (Game of Thrones)", sala: ARCHIVO_SALA, audioUrl: "audio/cine_cancioncorona.mp3", originalObra: "Juego de Tronos (Serie/Libros)" },
        { titulo: "Me llamo Bond, James Bond", autor: "Varios Autores", sala: ARCHIVO_SALA, audioUrl: "audio/cine_bond.mp3", originalObra: "007 Saga" },
        { titulo: "Mi tesoro", autor: "Peter Jackson", sala: ARCHIVO_SALA, audioUrl: "audio/cine_mitesoro.mp3", originalObra: "El Se√±or de los Anillos: Las Dos Torres" },
        { titulo: "Misi√≥n conseguida", autor: "Varios Directores", sala: ARCHIVO_SALA, audioUrl: "audio/cine_mision.mp3", originalObra: "Misi√≥n Imposible Saga" },
        { titulo: "No olvides tu nombre", autor: "Hayao Miyazaki", sala: ARCHIVO_SALA, audioUrl: "audio/cine_noolvides.mp3", originalObra: "El Viaje de Chihiro" },
        { titulo: "No... I'm your father", autor: "George Lucas", sala: ARCHIVO_SALA, audioUrl: "audio/cine_vader.mp3", originalObra: "Star Wars: Episodio V - El Imperio Contraataca" },
        { titulo: "Noche de Cristal", autor: "Steven Spielberg", sala: ARCHIVO_SALA, audioUrl: "audio/cine_nochecristal.mp3", originalObra: "La lista de Schindler" },
        { titulo: "Que la fuerza te acompa√±e.", autor: "George Lucas", sala: ARCHIVO_SALA, audioUrl: "audio/cine_fuerza.mp3", originalObra: "Star Wars: Episodio IV - Una Nueva Esperanza" },
        { titulo: "Sayonara Baby", autor: "James Cameron", sala: ARCHIVO_SALA, audioUrl: "audio/cine_sayonara.mp3", originalObra: "Terminator 2: El Juicio Final" },
        { titulo: "Soy el rey del mundo", autor: "James Cameron", sala: ARCHIVO_SALA, audioUrl: "audio/cine_rey.mp3", originalObra: "Titanic" },
        { titulo: "The Wire Fence", autor: "Autor Desconocido", sala: ARCHIVO_SALA, audioUrl: "audio/cine_wirefence.mp3", originalObra: "Pel√≠cula/Serie de Drama" },
        { titulo: "Un hogar", autor: "Steven Spielberg", sala: ARCHIVO_SALA, audioUrl: "audio/cine_hogar.mp3", originalObra: "E.T. El Extraterrestre" },
        { titulo: "Veinte a√±os de pico y poster", autor: "Frank Darabont", sala: ARCHIVO_SALA, audioUrl: "audio/cine_veinteanios.mp3", originalObra: "Cadena Perpetua" },
        { titulo: "Volver√©", autor: "James Cameron", sala: ARCHIVO_SALA, audioUrl: "audio/cine_volvere.mp3", originalObra: "Terminator" }
    ].sort((a, b) => a.titulo.localeCompare(b.titulo));


    function obtenerDatos() {
        const data = localStorage.getItem(CLAVE_LOCAL);
        return data ? JSON.parse(data) : [];
    }

    function guardarDatos(data) {
        localStorage.setItem(CLAVE_LOCAL, JSON.stringify(data));
    }

    // Asegura que los datos de esta sala (y s√≥lo esta) est√©n correctamente sincronizados con el localStorage
    function inicializarDatos() {
        let datos = obtenerDatos();
        let existeCambio = false;

        // 1. Limpiar entradas obsoletas de esta sala
        datos = datos.filter(d => 
            d.sala !== ARCHIVO_SALA || entradasBase.some(base => 
                base.titulo === d.titulo && base.autor === d.autor
            )
        );

        // 2. A√±adir nuevas entradas/actualizar metadatos de esta sala
        entradasBase.forEach(entradaBase => {
            const yaExiste = datos.some(d => 
                d.titulo === entradaBase.titulo && d.autor === entradaBase.autor && d.sala === entradaBase.sala
            );
            
            if (!yaExiste) {
                datos.push(entradaBase);
                existeCambio = true;
            } else {
                // Actualizar posibles campos nuevos como audioUrl u originalObra si no existen
                const index = datos.findIndex(d => d.titulo === entradaBase.titulo && d.autor === entradaBase.autor && d.sala === entradaBase.sala);
                if (index !== -1) {
                    if (datos[index].audioUrl !== entradaBase.audioUrl || datos[index].originalObra !== entradaBase.originalObra) {
                        datos[index].audioUrl = entradaBase.audioUrl;
                        datos[index].originalObra = entradaBase.originalObra; // A√±adido para mantener la consistencia
                        existeCambio = true;
                    }
                }
            }
        });

        if (existeCambio) {
            guardarDatos(datos);
        }
        
        return datos;
    }

    function cargarEntradas() {
        const contenedor = document.getElementById('lista-entradas');
        contenedor.innerHTML = '';
        
        const todosLosDatos = inicializarDatos();
        
        // Filtrar y ordenar las entradas S√ìLO de esta sala
        const entradasDeSala = todosLosDatos.filter(d => d.sala === ARCHIVO_SALA).sort((a, b) => a.titulo.localeCompare(b.titulo));
        
        const currentCoins = getGlobalCoins();

        entradasDeSala.forEach((e, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.setAttribute('data-index-in-data', index);
            itemDiv.className = 'entrada-item';

            const cardOwned = isCardOwned(e.titulo, e.autor, e.sala);
            const buyButtonDisabled = cardOwned || currentCoins < CARD_COST;
            const buyButtonText = cardOwned ? 'En tu Perfil' : `<i class="fas fa-coins"></i> Comprar (${CARD_COST})`;

            const lyricsButtonDisabled = currentCoins < LYRICS_COST;
            const lyricsButtonText = lyricsButtonDisabled ? `<i class="fas fa-coins"></i> Letras (${LYRICS_COST})` : `<i class="fas fa-file-alt"></i> Letras (${LYRICS_COST})`;

            itemDiv.innerHTML = `
                <div class="titulo-autor">
                    <div class="titulo">${e.titulo}</div>
                    <div class="autor">Director: ${e.autor}</div>
                    ${e.originalObra ? `<div class="original-obra">Basado en: ${e.originalObra}</div>` : ''} </div>
                
                <div class="controles-audio">
                    <audio id="audio-${index}" src="${e.audioUrl}"></audio>
                    <button class="control-btn play-btn" onclick="controlarAudio(${index}, 'play')" title="Reproducir">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn stop-btn" onclick="controlarAudio(${index}, 'stop')" title="Parar">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
                
                <div class="controles-compra">
                    <button class="buy-btn" 
                        onclick="buyCard(${index}, ${CARD_COST})" 
                        ${buyButtonDisabled ? 'disabled' : ''}
                    >
                        ${buyButtonText}
                    </button>
                    <button class="lyrics-btn" 
                        onclick="buyLyrics(${index}, ${LYRICS_COST})"
                        ${lyricsButtonDisabled ? 'disabled' : ''}
                    >
                        ${lyricsButtonText}
                    </button>
                </div>
            `;
            contenedor.appendChild(itemDiv);
        });
        
        hacerListaArrastrable(); 
    }

    // --- Funci√≥n para hacer la lista arrastrable (SIN REORDENAR) ---
    function hacerListaArrastrable() {
        const lista = document.getElementById('lista-entradas');
        
        // Se mantiene la funcionalidad de Sortable, pero se deshabilita la reordenaci√≥n
        new Sortable(lista, {
            animation: 150,
            disabled: true, 
        });
    }
    
    // --- Funci√≥n de Control de Audio (Se mantiene) ---
    function controlarAudio(index, accion) {
        const audio = document.getElementById(`audio-${index}`);
        
        // Pausar otros audios
        document.querySelectorAll('audio').forEach((a, i) => {
            if (i !== index && !a.paused) {
                a.pause();
                a.currentTime = 0;
            }
        });

        if (accion === 'play') {
            if (audio.paused) {
                audio.play().catch(error => {
                    alert(`Error al reproducir el audio: Comprueba que la URL "${audio.src}" es correcta.`);
                    console.error("Error de reproducci√≥n:", error);
                });
            }
        } else if (accion === 'stop') {
            audio.pause();
            audio.currentTime = 0;
        }
    }

    // Cargar los datos y la lista al iniciar
    window.onload = cargarEntradas;
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala 1 - Literatura Musical</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animaciones Personalizadas (Se mantienen las originales) */
        @keyframes pulse-custom {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.3; }
        }
        @keyframes bounce-custom {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes blink-custom {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-custom { animation: pulse-custom 3s ease-in-out infinite; }
        .animate-bounce-custom { animation: bounce-custom 2s ease-in-out infinite; }
        .animate-blink-custom { animation: blink-custom 1s step-start infinite; }

        @keyframes bounce-sala1 {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .animate-bounce-sala1 {
            animation: bounce-sala1 1.5s ease-in-out infinite;
        }

        .hidden { display: none; }
        
        .image-placeholder {
            background-color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4b5563;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    
   <header class="bg-indigo-950 p-4 shadow-xl sticky top-0 z-10 border-b border-indigo-800">
    <div class="container mx-auto flex flex-col items-center">
        
        <h1 class="text-xl md:text-3xl font-extrabold text-teal-400 flex items-center justify-center w-full mb-2">
            <svg class="w-6 h-6 md:w-8 md:h-8 mr-2 text-yellow-400 animate-bounce-sala1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-8z"/>
            </svg>
            Sala 1
        </h1>
        
        <div class="w-full flex justify-between items-center mb-2 md:mb-4">
            
             <div class="flex items-center space-x-4 text-sm md:text-lg">
                <span class="text-cyan-400">Votos Restantes: <span id="votesRemainingDisplay" class="font-bold text-yellow-400">5</span></span>
                <span class="text-cyan-400 hidden sm:inline-block">|</span>
                <span class="text-cyan-400">Estrellas Acumuladas:<span id="userStarsDisplay" class="font-bold text-yellow-400">0</span></span>
             </div>
             
             <div class="flex items-center space-x-2 md:space-x-4">
                <button onclick="openGlobalInfoModal()" class="bg-indigo-700 hover:bg-indigo-600 p-2 rounded-full transition-all hover:scale-105">
                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
                
                <div class="relative" id="profileMenuContainer">
                    <button onclick="toggleProfileDropdown()" class="bg-emerald-600 hover:bg-emerald-700 p-2 rounded-full transition-all hover:scale-105">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </button>
                    
                    <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-indigo-800 rounded-lg shadow-xl py-2 z-20 hidden border border-indigo-700">
                        <a onclick="openMissionModal()" class="block px-4 py-2 text-sm text-white hover:bg-indigo-700 cursor-pointer flex items-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.5 10l-4 4-2-2m0 0l-4 4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"></path></svg>
                             Nuestra Misi√≥n
                        </a>
                        <a href="perfil.html" class="block px-4 py-2 text-sm text-white hover:bg-indigo-700 flex items-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                             Perfil Usuario
                        </a>
                        <div class="border-t border-indigo-700 my-1"></div>
                        <a onclick="logout()" class="block px-4 py-2 text-sm text-red-400 hover:bg-indigo-700 cursor-pointer flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3v-3m0-6V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex items-center space-x-2 md:space-x-4 w-full justify-center">
            <a href="temas.html" class="bg-purple-600 hover:bg-purple-700 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Volver a Temas</a>
        </div>
        
        <p class="text-center text-lg md:text-xl font-medium text-cyan-300 mt-4 px-4">
            Elije 5 canciones que mas te guste para competir por el tercer, segundo y primer puesto.
        </p>
        
    </div>
</header>
    
    <main class="container mx-auto p-6">
        
        <section class="mb-12">
            <h2 class="text-4xl font-extrabold text-center mb-8  text-yellow-400 drop-shadow-lg">üèÜ Top 3: Lo m√°s votado üèÜ</h2>
            <div id="top3Container" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                </div>
        </section>

        <section>
            <h2 class="text-3xl font-bold text-center mb-8 text-teal-400">Resto del Ranking</h2>
            <div id="rankingContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> 
                </div>
        </section>
    </main>
    
    <div id="infoModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-cyan-900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border-2 border-cyan-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-end">
                <button onclick="closeInfoModal()" class="hover:bg-indigo-800 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="infoContent" class="p-6 text-white">
                </div>
        </div>
    </div>

    <div id="missionModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-purple-900 rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto border-2 border-purple-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-800 p-4 flex justify-between items-center border-b border-indigo-600">
                <h2 class="text-xl md:text-2xl font-bold text-white">Nuestra Misi√≥n</h2>
                <button onclick="closeMissionModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 text-white space-y-4">
                <p class="text-lg font-semibold text-yellow-300">¬°Bienvenidos a Literatura Musical!</p>
                <p>Nuestra misi√≥n es conectar dos mundos aparentemente distintos pero profundamente relacionados: la **Literatura Cl√°sica** y la **M√∫sica Contempor√°nea**.</p>
                <p>A trav√©s de adaptaciones musicales de obras ic√≥nicas, buscamos:</p>
                <ul class="list-disc list-inside space-y-2 ml-4 text-cyan-200">
                    <li>**Rejuvenecer** la apreciaci√≥n por los grandes autores y sus textos.</li>
                    <li>Ofrecer una **experiencia sensorial √∫nica** que complemente la lectura.</li>
                    <li>Crear una **comunidad de votaci√≥n** donde los usuarios decidan qu√© adaptaciones merecen estar en la cima.</li>
                    <li>**Incentivar el aprendizaje** de forma l√∫dica a trav√©s de los Quizzes.</li>
                    </ul>
                <p class="pt-4 text-sm text-gray-400">¬°Gracias por formar parte de esta sinfon√≠a de letras y melod√≠as!</p>
            </div>
        </div>
    </div>
    
    <div id="globalInfoModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-950 to-indigo-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-2 border-yellow-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-yellow-400 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Informaci√≥n y Comunidad
                </h2>
                <button onclick="closeGlobalInfoModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 text-white space-y-8">
                
                <section class="border-b border-indigo-700 pb-6">
                    <h3 class="text-xl font-bold mb-3 text-teal-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        Mec√°nica de Votaci√≥n
                    </h3>
                    <ul class="list-disc list-inside space-y-2 ml-4 text-gray-300">
                        <li>Cada usuario dispone de **5 votos semanales** (l√≠mite en el apartado de votos).</li>
                        <li>Cada voto se realiza gastando una cantidad de estrellas: **5, 6, 7, 8, 9 o 10 estrellas**.</li>
                        <li>**Restricci√≥n clave:** Solo se puede votar con una cantidad de estrellas **igual o menor** a las estrellas que tienes acumuladas.</li>
                        <li>Las estrellas elegidas para votar se **restan** de tus estrellas acumuladas.</li>
                        <li>Tus votos restantes y estrellas acumuladas se muestran en la cabecera.</li>
                    </ul>
                </section>
                
                <section class="border-b border-indigo-700 pb-6">
                    <h3 class="text-xl font-bold mb-3 text-teal-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002-2h2a2 2 0 002 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        Mec√°nica de Quiz y Estrellas Acumuladas
                    </h3>
                    <ul class="list-disc list-inside space-y-2 ml-4 text-gray-300">
                        <li>El **a√±o** y el **g√©nero** de la obra ahora son **visibles** por defecto.</li>
                        <li>Debes hacer clic en el bot√≥n **HACER QUIZZ** para participar.</li>
                        <li class="font-bold text-yellow-300">Las preguntas del quiz son ahora **aleatorias** y se centran en el **contenido y trama de la obra literaria** (personajes, actos, detalles del poema, etc.).</li>
                        <li>Los datos se guardan: una vez acertado el quiz, el bot√≥n **HACER QUIZZ** desaparece.</li>
                        <li class="font-bold text-teal-400">Estrellas Acumuladas (Moneda):</li>
                        <ul class="list-disc list-inside ml-8 text-cyan-300">
                            <li>Se ganan **5 estrellas** por cada pregunta acertada.</li>
                            <li>Se ganan **10 estrellas mas de bonificaci√≥n** si aciertas las 5 preguntas (m√°ximo 35 estrellas).</li>
                            <li class="font-bold text-red-400">Si aciertas las 5 preguntas, ganas un <span class="text-white">DIAMANTE</span> üíé para esa canci√≥n.</li>
                            <li>Estas estrellas se acumulan en tu saldo (apartado Estrellas) para poder gastarlas en votos.</li>
                        </ul>
                    </ul>
                </section>

                <section>
                    <h3 class="text-xl font-bold mb-4 text-teal-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.208 5 7.5 5c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8c0-1.708-.477-3.332-1.253-4.75z"></path></svg>
                        Muro de Comentarios Globales
                    </h3>
                    <p class="text-sm text-gray-400 mb-4">¬°Comparte tus pensamientos generales sobre la web o la m√∫sica aqu√≠!</p>
                    
                    <div class="mb-6">
                        <textarea id="globalCommentInput" placeholder="A√±ade un comentario global..." class="w-full bg-indigo-900/50 border border-indigo-600 rounded-lg p-3 text-white placeholder-indigo-400 focus:outline-none focus:border-indigo-400" rows="3"></textarea>
                        <button onclick="addGlobalComment()" class="mt-2 bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded-lg font-bold transition">A√±adir Comentario</button>
                    </div>
                    
                    <div id="globalCommentsContainer" class="space-y-3">
                        <p class="text-center text-gray-500 italic" id="noGlobalCommentsMessage">No hay comentarios a√∫n. ¬°S√© el primero en comentar!</p>
                    </div>
                </section>
                
            </div>
        </div>
    </div>
    
    <div id="voteSelectionModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-emerald-900 rounded-2xl max-w-sm w-full border-2 border-emerald-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-xl font-bold text-emerald-400">Elige la Cantidad de Estrellas para Votar</h2>
                <button onclick="closeVoteSelectionModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 text-white space-y-4">
                <p class="text-lg mb-4">Tienes **<span id="userStarsInModal" class="text-yellow-400 font-bold">0</span>** Estrellas Acumuladas.</p>
                <div id="voteOptionsContainer" class="grid grid-cols-3 gap-2">
                    </div>
                <p class="text-sm text-gray-400 pt-2">Solo puedes seleccionar valores de estrella que puedas pagar con tus estrellas acumuladas.</p>
            </div>
        </div>
    </div>


    <div id="lyricsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-40 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-yellow-900 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-2 border-yellow-400 shadow-2xl">
             <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-yellow-400" id="lyricsTitle">Letra de la Canci√≥n</h2> 
                <button onclick="closeLyricsModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="lyricsContent" class="p-6 text-white whitespace-pre-wrap font-serif">
                </div>
        </div>
    </div>
    
    <div id="quizModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-red-900 rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto border-2 border-red-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-red-400" id="quizTitle">Quiz de la Obra</h2>
                <button onclick="closeQuizModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="quizContent" class="p-6 text-white space-y-6">
                </div>
        </div>
    </div>
    
    <footer class="bg-indigo-950 p-4 shadow-inner mt-12 border-t border-indigo-800">
        <div class="container mx-auto flex justify-center items-center">
            <a href="https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB" target="_blank" class="text-red-400 hover:text-red-500 font-semibold flex items-center gap-2 transition-all">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.64-1.34-7.28-1.34-10.92 0C4.372 4.524 2.82 6.84 2.11 9.47 1.4 12.1 1.4 14.9 2.11 17.53c.71 2.63 2.262 4.946 6.585 6.286 3.64 1.34 7.28 1.34 10.92 0 4.323-1.34 5.875-3.656 6.585-6.286.71-2.63.71-5.43 0-8.06-.71-2.63-2.262-4.946-6.585-6.286zM10 16.5v-9l6 4.5-6 4.5z"></path></svg>
                Visita nuestro canal en YouTube
            </a>
        </div>
    </footer>


    <script>
        // --- DATA DE CANCIONES (BASE) ---
        // NOTA IMPORTANTE: Debes a√±adir el campo 'localAudioUrl' a cada objeto de canci√≥n con la ruta de tu archivo de audio local.
        var initialSongs = [
            { id: 1, title: "Veinte Poemas de Amor", author: "Pablo Neruda", year: 1924, genre: "Poes√≠a L√≠rica", image: "imagenportada/poemas.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1rDezgL9BLhX3x_u3WQnwIylyVQL3jraH/view?usp=sharing", localAudioUrl: "audio/poemas.mp3", description: "Adaptaci√≥n musical de los ic√≥nicos versos de amor de Neruda, transformando su melancol√≠a en melod√≠a.", comments: [], lyrics: `Para mi coraz√≥n basta tu pecho,
            Para tu libertad bastan mis alas.
            Desde mi boca llegar√° hasta el cielo
            lo que estaba dormido sobre tu alma.
            
            Es la hora de la partida, la dura y fr√≠a hora
            que la noche sujeta a todo horario.
            El cuerpo de la amada se queda conmigo,
            su ausencia ha sembrado la casa de dudas.`, quizData: { correctPrize: "Premio Nobel de Literatura" }, unlocked: false, listened: false, hasDiamond: false, theme: "Amor, Melancol√≠a y Naturaleza", generation: "Generaci√≥n del 27 (Influencia)", authorHighlight: "Poeta de Chile, gran diplom√°tico.",
             contentQuizData: {
                questions: [
                    { q: "¬øQu√© elemento se menciona como suficiente para la libertad del poeta?", a: "Mis alas", d: ["Tu pecho", "La noche", "El cielo"] },
                    { q: "¬øQu√© ha sembrado la ausencia de la amada en la casa?", a: "Dudas", d: ["Soledad", "Luz", "Alegr√≠a"] },
                    { q: "¬øQu√© parte del cuerpo de la amada se queda con el poeta?", a: "Su cuerpo", d: ["Su alma", "Su voz", "Su coraz√≥n"] },
                    { q: "¬øQu√© sube hasta el cielo desde la boca del poeta?", a: "Lo dormido sobre tu alma", d: ["Su amor", "Un ave", "Un silencio"] },
                    { q: "¬øQu√© hora describe el poeta como 'dura y fr√≠a'?", a: "La hora de la partida", d: ["El crep√∫sculo", "El amanecer", "El mediod√≠a"] }
                ]
            }
            },
            
            { id: 2, title: "Romancero Gitano", author: "Federico Garc√≠a Lorca", year: 1928, genre: "Poes√≠a L√≠rica", image: "imagenportada/romancero.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1gjwNaLyF9pcyDi3hAnp8mC242AOSisWH/view?usp=drive_link", localAudioUrl: "audio/romancero.mp3", description: "La pasi√≥n flamenca de Lorca convertida en una experiencia musical √∫nica e inolvidable. Poema: Romance de la luna, luna", comments: [], lyrics: `La luna vino a la fragua
            con su polis√≥n de nardos.
            El ni√±o la mira mira.
            El ni√±o la est√° mirando.
            
            En el aire conmovido
            mueve la luna sus brazos
            y ense√±a, l√∫brica y pura,
            sus senos de duro esta√±o.`, quizData: { correctPrize: "Ninguno" }, unlocked: false, listened: false, hasDiamond: false, theme: "Muerte, Injusticia, Mundo Gitano", generation: "Generaci√≥n del 27", authorHighlight: "Dramaturgo m√°s influyente del s.XX en Espa√±a.",
             contentQuizData: {
                questions: [
                    { q: "¬øQui√©n llega a la fragua?", a: "La luna", d: ["El gitano", "Un caballo", "El herrero"] },
                    { q: "¬øCon qu√© prenda se adorna la luna?", a: "Su polis√≥n de nardos", d: ["Vestido de seda", "Flores blancas", "Falda de encaje"] },
                    { q: "¬øQu√© le ense√±a la luna al ni√±o?", a: "Sus senos de duro esta√±o", d: ["Una navaja", "Un tesoro", "Su sonrisa"] },
                    { q: "¬øC√≥mo se describe la luna mientras mueve sus brazos?", a: "L√∫brica y pura", d: ["P√°lida y fr√≠a", "Grande y redonda", "Roja y sangrienta"] },
                    { q: "¬øQui√©n mira fijamente a la luna?", a: "El ni√±o", d: ["La madre", "El gitano", "El fuego"] }
                ]
            }
            },
            
            { id: 3, title: "Canci√≥n del Pirata", author: "Jos√© de Espronceda", year: 1840, genre: "Poes√≠a L√≠rica", image: "imagenportada/cancionpirata.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1tw_b57Ta0etgoN_miF4eLOEjAx2TGN6a/view?usp=sharing", localAudioUrl: "audio/pirata.mp3", description: "La libertad y aventura del romanticismo espa√±ol en una composici√≥n musical √©pica.", comments: [], lyrics: `Con diez ca√±ones por banda,
            viento en popa, a toda vela,
            no corta el mar, sino vuela,
            un velero bergant√≠n.
            
            Bajel pirata que llaman
            por su bravura el Temido,
            en todo mar conocido
            del uno al otro conf√≠n.`, quizData: { correctPrize: "Ninguno" }, unlocked: false, listened: false, hasDiamond: false, theme: "Libertad, Rebeld√≠a y Naturaleza marina", generation: "Romanticismo espa√±ol", authorHighlight: "Poeta y activista liberal, figura central del Romanticismo.",
             contentQuizData: {
                questions: [
                    { q: "¬øCon cu√°ntos ca√±ones navega el bergant√≠n?", a: "Diez", d: ["Ocho", "Doce", "Catorce"] },
                    { q: "¬øQu√© hace la nave en lugar de 'cortar el mar'?", a: "Vuela", d: ["Flota", "Se hunde", "Navega lento"] },
                    { q: "¬øCu√°l es el nombre del bajel pirata?", a: "El Temido", d: ["El Valiente", "El Audaz", "El Veloz"] },
                    { q: "¬øQu√© elemento le da velocidad a la nave?", a: "Viento en popa", d: ["Remos fuertes", "M√°quinas de vapor", "Corrientes marinas"] },
                    { q: "¬øDe d√≥nde a d√≥nde es conocido el bajel?", a: "Del uno al otro conf√≠n", d: ["De puerto a puerto", "En el Mediterr√°neo", "En todos los mares"] }
                ]
            }
            },
            
            { id: 4, title: "Campos de Castilla", author: "Antonio Machado", year: 1912, genre: "Poes√≠a L√≠rica", image: "imagenportada/campos.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1Ciam4_Yijz1Eobkex1P4RCRLr07nTHX-/view?usp=drive_link", localAudioUrl: "audio/campos.mp3", description: "Los paisajes castellanos de Machado cobran vida en una melod√≠a contemplativa y profunda.", comments: [], lyrics: `Mi infancia son recuerdos de un patio de Sevilla,
y un huerto claro donde madura el limonero;
mi juventud, veinte a√±os en tierra de Castilla;
mi historia, algunos casos que recordar no quiero.`, quizData: { correctPrize: "Ninguno" }, unlocked: false, listened: false, hasDiamond: false, theme: "El paisaje, el paso del tiempo y la esencia de Espa√±a", generation: "Generaci√≥n del 98", authorHighlight: "El m√°s joven y melanc√≥lico de la Generaci√≥n del 98.",
             contentQuizData: {
                questions: [
                    { q: "¬øQu√© recuerda el poeta de su infancia en Sevilla?", a: "Un patio", d: ["Una plaza", "Una casa", "Un r√≠o"] },
                    { q: "¬øQu√© fruto madura en el huerto de su infancia?", a: "El limonero", d: ["El naranjo", "El manzano", "El almendro"] },
                    { q: "¬øCu√°ntos a√±os de su vida vivi√≥ en Castilla?", a: "Veinte a√±os", d: ["Diez a√±os", "Toda su vida", "Cinco a√±os"] },
                    { q: "¬øC√≥mo describe el poeta al huerto de su infancia?", a: "Claro", d: ["Sombr√≠o", "Seco", "Grande"] },
                    { q: "¬øQu√© parte de su vida prefiere no recordar?", a: "Algunos casos de su historia", d: ["Sus amores", "Su tristeza", "Su exilio"] }
                ]
            }
            },
            
            { id: 5, title: "Altazor", author: "Vicente Huidobro", year: 1931, genre: "Poes√≠a Vanguardista", image: "imagenportada/altazor.png", totalStars: 0, youtubeUrl: "https://youtu.be/Nqo1WXHvjoI?si=TDlmUXkYrf-Xcrq", driveUrl: "https://drive.google.com/file/d/1AcgtWTs8pOFsdRBvKBHisPX_HkXw2ORK/view?usp=drive_link", localAudioUrl: "audio/altazor.mp3", description: "La vanguardia po√©tica transformada en una experiencia sonora experimental y revolucionaria.", comments: [], lyrics: `No hay tiempo que perder.
            Vamos a la luna o al sol,
            o donde sea,
            donde las manos puedan cortar
            la vida del instante
            que se abre en las manos del hombre.`, quizData: { correctPrize: "Premio Nacional de Literatura de Chile" }, unlocked: false, listened: false, hasDiamond: false, theme: "Creacionismo, el poeta como Dios y la destrucci√≥n del lenguaje", generation: "Vanguardismo (Creacionismo)", authorHighlight: "Creador del movimiento po√©tico del Creacionismo.",
             contentQuizData: {
                questions: [
                    { q: "¬øQu√© parte del cuerpo humano corta la vida del instante?", a: "Las manos", d: ["Los ojos", "La boca", "Los pies"] },
                    { q: "¬øA d√≥nde propone el poeta ir a cortar la vida del instante?", a: "A la luna o al sol", d: ["Al pasado", "Al futuro", "A la tierra"] },
                    { q: "¬øQu√© se abre en las manos del hombre?", a: "La vida del instante", d: ["Un libro", "Un paraca√≠das", "Un abismo"] },
                    { q: "¬øCu√°l es la frase que subraya la urgencia al inicio del fragmento?", a: "No hay tiempo que perder.", d: ["Vamos donde sea.", "El instante se abre.", "Las manos cortan."] },
                    { q: "¬øQu√© concepto principal del Vanguardismo ilustra este fragmento?", a: "El poeta como Dios (Creacionismo)", d: ["El amor rom√°ntico", "La cr√≠tica social", "El realismo m√°gico"] }
                ]
            }
            },
            
            { id: 6, title: "Trilce", author: "C√©sar Vallejo", year: 1922, genre: "Poes√≠a Vanguardista", image: "imagenportada/trilce.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1ArrRC6iAOXmFBsJUw5gMCRWfHLD_MIwx/view?usp=drive_link", localAudioUrl: "audio/trilce.mp3", description: "La innovaci√≥n ling√º√≠stica de Vallejo encuentra su expresi√≥n en armon√≠as sorprendentes.", comments: [], lyrics: `Qui√©n hace tanta bulla y ni deja
            testar las √∫nicas herencias.
            Y quien de una simple trenza
            hace toda una madeja.
            
            D√≠a y noche, d√≠a y noche
            sin darnos un respiro, un desvelo.
            El hambre en el vientre del cielo.`, quizData: { correctPrize: "Ninguno" }, unlocked: false, listened: false, hasDiamond: false, theme: "Soledad, prisi√≥n, dolor humano y lenguaje experimental", generation: "Vanguardismo (Post-Modernismo)", authorHighlight: "M√°ximo exponente de la vanguardia po√©tica en espa√±ol.",
             contentQuizData: {
                questions: [
                    { q: "¬øQu√© no deja hacer la bulla seg√∫n el poema?", a: "Testar las √∫nicas herencias", d: ["Dormir", "Hablar", "Escribir"] },
                    { q: "¬øQu√© se hace de una simple trenza?", a: "Toda una madeja", d: ["Una cuerda", "Un nudo", "Un ovillo"] },
                    { q: "¬øD√≥nde se localiza el hambre mencionada?", a: "En el vientre del cielo", d: ["En el est√≥mago", "En la tierra", "En el poeta"] },
                    { q: "¬øQu√© pide el poeta que no se le da 'D√≠a y noche'?", a: "Un respiro, un desvelo", d: ["Silencio", "Comida", "Consuelo"] },
                    { q: "¬øQu√© palabra inusual usa Vallejo para hablar de la 'herencia'?", a: "Testar", d: ["Recibir", "Declarar", "Dejar"] }
                ]
            }
            },
            
            { id: 7, title: "La Voz a Ti Debida", author: "Pedro Salinas", year: 1933, genre: "Poes√≠a L√≠rica", image: "imagenportada/lavoz.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/17dRJL2X7fq5rlRn6ho-KsSETGs5Qkeb2/view?usp=drive_link", localAudioUrl: "audio/lavoz.mp3", description: "El amor puro de Salinas convertido en una balada contempor√°nea llena de sentimiento.", comments: [], lyrics: `T√∫ vives siempre en tus actos.
            Con la muerte, el tel√≥n
            bajo el cual la vida.
            Si, pero es una vida sin ti,
            sin el que t√∫ eras.
            Es la vida en su forma
            m√°s triste, su forma
            de recuerdo.`, quizData: { correctPrize: "Ninguno" }, unlocked: false, listened: false, hasDiamond: false, theme: "El amor como fuerza creadora y esencia de la vida", generation: "Generaci√≥n del 27", authorHighlight: "El poeta del amor dentro de la Generaci√≥n del 27.",
             contentQuizData: {
                questions: [
                    { q: "¬øD√≥nde vive el ser amado seg√∫n el poeta?", a: "En sus actos", d: ["En su memoria", "En su coraz√≥n", "En el cielo"] },
                    { q: "¬øQu√© baja junto con la muerte?", a: "El tel√≥n", d: ["La lluvia", "La noche", "La cortina"] },
                    { q: "¬øC√≥mo describe el poeta a la vida sin el ser amado?", a: "Su forma m√°s triste", d: ["Su forma m√°s pura", "Su forma m√°s solitaria", "Su forma m√°s libre"] },
                    { q: "¬øCu√°l es la forma m√°s triste de la vida?", a: "De recuerdo", d: ["De esperanza", "De vac√≠o", "De olvido"] },
                    { q: "¬øQu√© contin√∫a existiendo bajo el tel√≥n de la muerte?", a: "La vida", d: ["El silencio", "La nada", "El amor"] }
                ]
            }
            },
            
            { id: 8, title: "Residencia en la Tierra", author: "Pablo Neruda", year: 1935, genre: "Poes√≠a Surrealista", image: "imagenportada/residencia.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1NtevvMlrWrlanbsIpIEpZYpf2fHNdfNC/view?usp=drive_link", localAudioUrl: "audio/residencia.mp3", description: "La angustia existencial nerudiana transmutada en composiciones oscuras y evocadoras.", comments: [], lyrics: `Barcarola.
            Si solamente me dieras
            la noche, la noche oscura.
            Y si solamente dieras
            el mar con sus olas furiosas,
            yo ser√≠a feliz.
            
            Pero me das la luz,
            la luna y el sol,
            y el tiempo.`, quizData: { correctPrize: "Premio Nobel de Literatura" }, unlocked: false, listened: false, hasDiamond: false, theme: "Angustia existencial, soledad y la decadencia de la vida moderna", generation: "Generaci√≥n del 27 (Influencia)", authorHighlight: "Poeta de Chile, gran diplom√°tico.",
             contentQuizData: {
                questions: [
                    { q: "¬øQu√© pide el poeta que se le d√© solamente?", a: "La noche, la noche oscura", d: ["La lluvia y el viento", "Un barco", "Un silencio profundo"] },
                    { q: "¬øQu√© m√°s pide que se le d√© junto a la noche?", a: "El mar con sus olas furiosas", d: ["La tierra y el fuego", "Una estrella", "Un recuerdo"] },
                    { q: "¬øQu√© afirma el poeta que ser√≠a si se le dieran esas cosas?", a: "Feliz", d: ["Triste", "Fuerte", "Dichoso"] },
                    { q: "¬øQu√© se le da al poeta que no desea en su lugar?", a: "La luz, la luna y el sol, y el tiempo", d: ["El dinero", "El amor", "La juventud"] },
                    { q: "¬øQu√© tipo de emoci√≥n predomina en el deseo del fragmento?", a: "Angustia y deseo de oscuridad", d: ["Alegr√≠a", "Nostalgia", "Indiferencia"] }
                ]
            }
            },
            
            { id: 9, title: "Poeta en Nueva York (Vuelta de paseo)", author: "Federico Garc√≠a Lorca", year: 1940, genre: "Poes√≠a Surrealista", image: "imagenportada/poeta.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1-9_6Om33P7uIMcHgNWYgws2zmHUeuqKB/view?usp=drive_link", localAudioUrl: "audio/poeta.mp3", description: "El surrealismo urbano de Lorca en la gran manzana, ahora en ritmos modernos.", comments: [], lyrics: `Asesinado por el cielo,
            entre las formas que van hacia la sierpe
            y las formas que buscan el cristal.
            
            Dejar√© crecer mis cabellos.
            Dejar√© crecer mis u√±as.
            Ir√© al mar con el traje roto,
            y el coraz√≥n destrozado.`, quizData: { correctPrize: "Ninguno" }, unlocked: false, listened: false, hasDiamond: false, theme: "Cr√≠tica a la civilizaci√≥n, angustia y deshumanizaci√≥n en la ciudad", generation: "Generaci√≥n del 27", authorHighlight: "Dramaturgo m√°s influyente del s.XX en Espa√±a.",
             contentQuizData: {
                questions: [
                    { q: "¬øQu√© es lo que asesina al poeta, seg√∫n el primer verso?", a: "El cielo", d: ["La ciudad", "El tiempo", "El miedo"] },
                    { q: "¬øQu√© formas buscan el cristal?", a: "Las formas", d: ["Las manos", "Las palabras", "Las sombras"] },
                    { q: "¬øQu√© dejar√° crecer el poeta?", a: "Sus cabellos y sus u√±as", d: ["Sus plantas", "Sus deudas", "Sus ideas"] },
                    { q: "¬øCon qu√© ir√° el poeta al mar?", a: "Con el traje roto, y el coraz√≥n destrozado", d: ["Con traje nuevo", "Con su familia", "En barco"] },
                    { q: "¬øHacia qu√© animal van las formas?", a: "Hacia la sierpe", d: ["Hacia el √°guila", "Hacia el le√≥n", "Hacia el delf√≠n"] }
                ]
            }
            },
            
            { id: 10, title: "Marinero en Tierra", author: "Rafael Alberti", year: 1925, genre: "Poes√≠a L√≠rica", image: "imagenportada/marinero.png", totalStars: 0, youtubeUrl: "https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB", driveUrl: "https://drive.google.com/file/d/1RoOZ6YiILZbmaQWX2-_4FGE_fuKyW1xB/view?usp=drive_link", localAudioUrl: "audio/marinero.mp3", description: "La nostalgia marinera de Alberti navega en melod√≠as que evocan el Mediterr√°neo.", comments: [], lyrics: `Yo, marinero, en la ribera m√≠a,
            navegando sin mar y sin nav√≠o.
            Caminando sobre el sol y el fr√≠o
            de la sed y el recuerdo.
            
            Dar√≠a por el mar de la ma√±ana
            la orilla de la tierra.
            Dar√≠a por la sombra de una barca
            esta llanura yerma.`, quizData: { correctPrize: "Premio Cervantes" }, unlocked: false, listened: false, hasDiamond: false, theme: "Nostalgia del mar, el para√≠so perdido de la infancia", generation: "Generaci√≥n del 27", authorHighlight: "El 'Poeta de la mar' y exiliado pol√≠tico.",
             contentQuizData: {
                questions: [
                    { q: "¬øEn qu√© est√° navegando el marinero de la ribera?", a: "Sin mar y sin nav√≠o", d: ["En un barco peque√±o", "En un r√≠o", "En un estanque"] },
                    { q: "¬øSobre qu√© camina el marinero en la ribera?", a: "Sobre el sol y el fr√≠o de la sed y el recuerdo", d: ["Sobre la arena", "Sobre las olas", "Sobre la cubierta"] },
                    { q: "¬øQu√© dar√≠a el poeta por el mar de la ma√±ana?", a: "La orilla de la tierra", d: ["Un diamante", "Todas sus estrellas", "Un abrazo"] },
                    { q: "¬øQu√© dar√≠a el poeta por la sombra de una barca?", a: "Esta llanura yerma", d: ["Su casa", "Su nombre", "Su libertad"] },
                    { q: "¬øDe qu√© sufre el marinero en la ribera?", a: "De la sed y el recuerdo", d: ["De calor", "De hambre", "De sue√±o"] }
                ]
            }
            }
        ];

        var songs = []; 
        var votesRemaining = 5; 
        var userStars = 0; 
        var totalStarsCount = 0; 
        var selectedSongId = null; 
        var lastUpdateDate = null; 
        var globalComments = [];
        
        var selectedSongs = []; // Canciones que el usuario ha marcado para su perfil

        // --- LOCAL STORAGE FUNCTIONS (sin cambios) ---
        function saveAppData() {
            localStorage.setItem('literatura_songs', JSON.stringify(songs));
            localStorage.setItem('literatura_votesRemaining', votesRemaining); 
            localStorage.setItem('literatura_lastUpdateDate', lastUpdateDate ? lastUpdateDate.toISOString() : null);
            localStorage.setItem('literatura_userStars', userStars); 
            localStorage.setItem('literatura_globalComments', JSON.stringify(globalComments)); 
            localStorage.setItem('literatura_totalStars', totalStarsCount); 
            localStorage.setItem('literatura_selectedSongs', JSON.stringify(selectedSongs));
        }

        function loadAppData() {
            const savedSongs = localStorage.getItem('literatura_songs');
            const savedVotes = localStorage.getItem('literatura_votesRemaining');
            const savedDate = localStorage.getItem('literatura_lastUpdateDate');
            const savedUserStars = localStorage.getItem('literatura_userStars');
            const savedGlobalComments = localStorage.getItem('literatura_globalComments');
            const savedTotalStars = localStorage.getItem('literatura_totalStars');
            const savedSelectedSongs = localStorage.getItem('literatura_selectedSongs');

            songs = savedSongs ? JSON.parse(savedSongs) : initialSongs;
            votesRemaining = savedVotes !== null && !isNaN(parseInt(savedVotes)) ? parseInt(savedVotes) : 5;
            userStars = savedUserStars !== null && !isNaN(parseInt(savedUserStars)) ? parseInt(savedUserStars) : 0;
            globalComments = savedGlobalComments ? JSON.parse(savedGlobalComments) : [];
            totalStarsCount = savedTotalStars !== null && !isNaN(parseInt(savedTotalStars)) ? parseInt(savedTotalStars) : 0;
            lastUpdateDate = savedDate && savedDate !== 'null' ? new Date(savedDate) : new Date();
            selectedSongs = savedSelectedSongs ? JSON.parse(savedSelectedSongs) : [];

            // Mapeo y saneamiento de datos al cargar (MIGRACI√ìN y nuevos campos)
            songs = songs.map(song => {
                const initial = initialSongs.find(s => s.id === song.id);
                
                if (!song.comments) song.comments = []; 
                if (typeof song.totalStars === 'undefined') song.totalStars = 0;
                
                if (initial) {
                    song.quizData = initial.quizData; 
                    if (typeof song.unlocked === 'undefined') song.unlocked = false; 
                    if (typeof song.listened === 'undefined') song.listened = false; 
                    if (typeof song.hasDiamond === 'undefined') song.hasDiamond = false; 
                    
                    // Sincronizar nuevos campos de Quiz
                    song.theme = initial.theme;
                    song.generation = initial.generation;
                    song.authorHighlight = initial.authorHighlight;
                    song.localAudioUrl = initial.localAudioUrl; // Asegurar campo de audio local
                    song.contentQuizData = initial.contentQuizData; // NUEVO: Asegurar campo de quiz de contenido
                }
                
                return song;
            });

            // Si el array de canciones guardado es m√°s corto que el inicial (a√±adir nuevas si existen)
            if (songs.length < initialSongs.length) {
                const existingIds = new Set(songs.map(s => s.id));
                initialSongs.forEach(newSong => {
                    if (!existingIds.has(newSong.id)) {
                        songs.push(newSong);
                    }
                });
            }
            
            // Recalcular totalStarsCount (solo si es necesario, para asegurar)
            if (totalStarsCount === 0 && songs.some(s => s.totalStars > 0)) {
                 totalStarsCount = songs.reduce((sum, song) => sum + (song.totalStars || 0), 0);
            }

            // Actualizar la cabecera
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            document.getElementById('userStarsDisplay').textContent = userStars;
        }
        
        // --- FUNCI√ìN PARA MARCAR COMO ESCUCHADA ---
        // Se llama al activar el evento 'onplay' del reproductor de audio en la tarjeta.
        function markAsListened(songId) {
            const songIndex = songs.findIndex(s => s.id === songId);
            if (songIndex !== -1 && !songs[songIndex].listened) {
                songs[songIndex].listened = true;
                saveAppData();
                renderRanking(); // Refrescar para habilitar el bot√≥n de selecci√≥n
                // alert(`¬°"${songs[songIndex].title}" marcada como escuchada!`); // Se comenta para evitar molestar
            }
        }
        
        // --- FUNCI√ìN PARA SELECCIONAR CANCI√ìN PARA PERFIL ---
        function selectSongForProfile(songId) {
            const song = songs.find(s => s.id === songId);
            if (!song) return;

            if (!song.listened) {
                alert("Debes escuchar la canci√≥n (hacer clic en Play del reproductor de audio) antes de elegirla para tu perfil.");
                return;
            }
            
            if (selectedSongs.length >= 5) {
                alert("Ya has elegido el m√°ximo de 5 canciones para tu perfil.");
                return;
            }

            if (selectedSongs.some(s => s.id === songId)) {
                 alert("Esta canci√≥n ya est√° elegida.");
                 return;
            }
            
            // A√±adir canci√≥n (copia solo datos esenciales para perfil)
            selectedSongs.push({
                id: song.id,
                title: song.title,
                author: song.author,
                image: song.image,
                hasDiamond: song.hasDiamond // Mantener el estado del diamante
            });
            
            saveAppData();
            renderRanking();
            alert(`¬°"${song.title}" ha sido elegida para tu perfil! Tienes ${selectedSongs.length} de 5.`);
        }

        // --- FUNCIONES DE MODALES, VOTACI√ìN y QUIZ (sin cambios en la l√≥gica) ---

        function toggleProfileDropdown() {
            document.getElementById('profileDropdown').classList.toggle('hidden');
        }

        function addGlobalComment() {
            var globalCommentInput = document.getElementById('globalCommentInput');
            var text = globalCommentInput.value.trim();
            if (text === "") return;

            var newComment = {
                text: text,
                timestamp: new Date().toLocaleString(),
                user: "Usuario An√≥nimo"
            };

            globalComments.unshift(newComment);
            globalCommentInput.value = '';
            saveAppData();
            renderGlobalComments();
        }

        function renderGlobalComments() {
            var globalCommentsContainer = document.getElementById('globalCommentsContainer');
            if (!globalCommentsContainer) return;

            if (globalComments.length === 0) {
                globalCommentsContainer.innerHTML = '<p class="text-center text-gray-500 italic" id="noGlobalCommentsMessage">No hay comentarios a√∫n. ¬°S√© el primero en comentar!</p>';
                return;
            }

            var globalCommentsHtml = globalComments.map(comment => {
                const userName = comment.user || 'Usuario An√≥nimo';
                return '<div class="bg-indigo-700/50 p-3 rounded-lg border border-indigo-500"><p class="text-xs font-semibold text-yellow-300">' + userName + ' (' + comment.timestamp + ')</p><p class="text-base">' + comment.text + '</p></div>';
            }).join('');
            
            globalCommentsContainer.innerHTML = globalCommentsHtml;
        }

        function openGlobalInfoModal() {
            document.getElementById('globalInfoModal').classList.remove('hidden');
            renderGlobalComments();
        }

        function closeGlobalInfoModal() {
            document.getElementById('globalInfoModal').classList.add('hidden');
        }
        
        function closeInfoModal() {
            document.getElementById('infoModal').classList.add('hidden');
            selectedSongId = null;
        }

        function openMissionModal() {
            document.getElementById('profileDropdown').classList.add('hidden');
            document.getElementById('missionModal').classList.remove('hidden');
        }
        
        function closeMissionModal() {
            document.getElementById('missionModal').classList.add('hidden');
        }

        function closeVoteSelectionModal() {
            document.getElementById('voteSelectionModal').classList.add('hidden');
            selectedSongId = null;
        }
        
        function logout() {
            // L√≥gica de logout simulada
            alert("Has cerrado sesi√≥n. Redireccionando a la p√°gina de inicio...");
            // window.location.href = 'login.html'; // Descomentar para un entorno real
        }

        function checkAndResetWeeklyData() {
            var today = new Date();
            if (!lastUpdateDate || (today.getTime() - lastUpdateDate.getTime()) > (7 * 24 * 60 * 60 * 1000)) {
                votesRemaining = 5; 
                lastUpdateDate = today;
                document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
                saveAppData();
                return;
            }
        }
        
        function openVoteSelectionModal(songId) {
            if (votesRemaining <= 0) {
                 alert("Has alcanzado el l√≠mite de 5 votos por semana. Vuelve la pr√≥xima semana.");
                 return;
            }
            
            selectedSongId = songId;
            document.getElementById('userStarsInModal').textContent = userStars;
            const voteOptionsContainer = document.getElementById('voteOptionsContainer');
            voteOptionsContainer.innerHTML = '';
            
            const voteValues = [5, 6, 7, 8, 9, 10];
            
            voteValues.forEach(value => {
                const canAfford = userStars >= value;
                const buttonClass = canAfford 
                    ? 'bg-emerald-500 hover:bg-emerald-600 cursor-pointer' 
                    : 'bg-gray-600 cursor-not-allowed opacity-50';
                    
                voteOptionsContainer.innerHTML += `
                    <button 
                        class="p-3 rounded-lg font-bold transition ${buttonClass}" 
                        ${canAfford ? `onclick="submitVote(${value})"` : 'disabled'}
                    >
                        ${value} ‚≠ê
                    </button>
                `;
            });
            
            document.getElementById('voteSelectionModal').classList.remove('hidden');
        }

        function submitVote(stars) {
            if (votesRemaining <= 0 || userStars < stars) {
                alert("Error en la votaci√≥n. Verifica tus estrellas y votos restantes.");
                closeVoteSelectionModal();
                return;
            }
            
            const songIndex = songs.findIndex(s => s.id === selectedSongId);
            if (songIndex === -1) {
                alert("Error: Canci√≥n no encontrada.");
                 closeVoteSelectionModal();
                return;
            }
            
            // 1. Restar estrellas del usuario
            userStars -= stars;
            document.getElementById('userStarsDisplay').textContent = userStars;
            
            // 2. Sumar estrellas a la canci√≥n
            songs[songIndex].totalStars += stars;
            
            // 3. Restar voto restante
            votesRemaining--;
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            
            // 4. Actualizar ranking y guardar
            saveAppData();
            renderRanking();
            
            alert(`¬°Voto realizado con √©xito! Se han gastado ${stars} estrellas. Te quedan ${votesRemaining} votos esta semana.`);
            closeVoteSelectionModal();
        }

        function renderRanking() {
            // 1. Ordenar por totalStars (descendente)
            songs.sort((a, b) => b.totalStars - a.totalStars);

            const top3Container = document.getElementById('top3Container');
            const rankingContainer = document.getElementById('rankingContainer');
            
            top3Container.innerHTML = '';
            rankingContainer.innerHTML = '';
            
            // 2. Renderizar Top 3
            songs.slice(0, 3).forEach((song, index) => {
                const position = index + 1;
                const topCard = createSongCard(song, position, true); 
                top3Container.innerHTML += topCard;
            });

            // 3. Renderizar Resto del Ranking
            songs.slice(3).forEach((song, index) => {
                const position = index + 4;
                const card = createSongCard(song, position, false);
                rankingContainer.innerHTML += card;
            });
            
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            document.getElementById('userStarsDisplay').textContent = userStars;
        }

        function createSongCard(song, position, isTop3 = false) {
            const starIcon = '<svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
            const defaultImage = song.image || 'imagenportada/default.png'; 
            
            const badgeClass = isTop3 
                ? (position === 1 ? 'bg-indigo-600' : (position === 2 ? 'bg-gray-400' : 'bg-amber-700')) 
                : 'bg-indigo-600';
                
            const cardClass = 'bg-gray-800 border border-gray-700 hover:bg-gray-700 flex flex-col';

            const isUnlocked = song.unlocked; 
            
            const titleDisplay = song.title; 
            const authorDisplay = song.author;
            
            // A√±o y G√©nero AHORA VISIBLES por defecto
            const yearDisplay = song.year;
            const genreDisplay = song.genre;

            const diamondIcon = song.hasDiamond ? 
                '<span class="ml-2 text-xl align-middle" title="¬°Quiz Perfecto!">üíé</span>' : '';
            
            // üö®üö®üö® MODIFICACI√ìN AQU√ç: REPRODUCTOR DE AUDIO LOCAL M√ÅS COMPACTO üö®üö®üö®
            const integratedPlayer = `
                <div class="w-full mt-1">
                    <audio id="audio-${song.id}" controls 
                           class="w-full h-8 bg-gray-600 rounded-lg shadow-inner min-w-[200px]"
                           onplay="markAsListened(${song.id})">
                        <source src="${song.localAudioUrl || 'audio/default.mp3'}" type="audio/mpeg">
                        Tu navegador no soporta el elemento de audio.
                    </audio>
                </div>
            `;
            
            // Bot√≥n de selecci√≥n 
            const isSelected = selectedSongs.some(s => s.id === song.id);
            const selectButtonClass = song.listened 
                ? (isSelected ? 'bg-gray-500 cursor-not-allowed' : 'bg-pink-600 hover:bg-pink-700') 
                : 'bg-gray-500 cursor-not-allowed';
            const selectButtonText = isSelected ? 'Elegida' : 'Elegir Canci√≥n'; 
            const selectButtonAction = song.listened && !isSelected ? `onclick="selectSongForProfile(${song.id})"` : 'disabled';
            const selectButtonTooltip = song.listened ? '' : 'title="Debes escuchar la canci√≥n primero."';

            const infoBlock = `
                <p class="text-base text-gray-300">Autor: <span class="font-semibold text-teal-400">${authorDisplay}</span></p>
                <p class="text-base text-gray-300">A√±o: <span class="font-semibold text-cyan-400">${yearDisplay}</span></p>
                <p class="text-base text-gray-300">G√©nero: <span class="font-semibold text-cyan-400">${genreDisplay}</span></p>
            `;
                  
            // El quiz solo se puede hacer una vez (si no est√° desbloqueado)
            const quizButton = !isUnlocked ? `<button onclick="openQuizModal(${song.id})" class="mt-2 w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg font-bold transition-all hover:scale-[1.02]">HACER QUIZZ</button>` : '';


            return `
                <div class="${cardClass} rounded-xl overflow-hidden shadow-lg relative">
                    <div class="absolute top-0 left-0 ${badgeClass} text-white font-black text-lg p-2 rounded-br-lg z-10 shadow-lg flex items-center gap-1">
                        ${isTop3 ? '<span class="text-xl">' + position + '</span>' : position} 
                    </div>
                    
                    <div class="image-placeholder h-48 w-full bg-cover bg-center" style="background-image: url('${defaultImage}')">
                        </div>
                    
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-2xl font-bold mb-2 text-yellow-400 flex items-center">
                            ${titleDisplay} ${diamondIcon}
                        </h3>
                        
                        <div class="mb-4 text-center">
                            ${integratedPlayer} 
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-4">${song.description}</p>
                        
                        <div class="border-t border-indigo-700 pt-3 mb-4 space-y-1">
                            ${infoBlock}
                            ${quizButton}
                        </div>
                        
                        <div class="mt-auto pt-3 border-t border-indigo-700 flex items-center justify-between">
                            
                            <div class="flex items-center space-x-1 text-yellow-400 font-bold text-lg">
                                ${starIcon}
                                <span>${song.totalStars} Estrellas</span>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <button onclick="openVoteSelectionModal(${song.id})" class="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg font-bold transition-all hover:scale-105 flex items-center gap-1" title="Votar">
                                     Votar
                                </button>
                                <button ${selectButtonAction} class="${selectButtonClass} px-3 py-2 rounded-lg font-bold transition-all hover:scale-105 text-sm" ${selectButtonTooltip}>
                                     ${selectButtonText}
                                </button>
                            </div>
                            
                        </div>
                        <div class="mt-3 flex justify-end">
                                <button onclick="openLyricsModal(${song.id})" class="bg-purple-700 hover:bg-purple-800 p-2 rounded-full transition-all hover:scale-110" title="Ver Letra">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                </button>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        // --- FUNCIONES PARA MODAL DE LETRAS (sin cambios) ---
        
        function openLyricsModal(songId) {
            const song = songs.find(s => s.id === songId);
            if (!song) return;

            document.getElementById('lyricsTitle').textContent = `Letra de: ${song.title}`;
            document.getElementById('lyricsContent').textContent = song.lyrics || 'Letra no disponible.';
            document.getElementById('lyricsModal').classList.remove('hidden');
        }

        function closeLyricsModal() {
            document.getElementById('lyricsModal').classList.add('hidden');
        }


        // --- FUNCIONES PARA MODAL DE QUIZ (MODIFICADAS) ---
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Funci√≥n para generar las preguntas del quiz centradas en el contenido de la obra
        function generateQuizQuestions(song, allSongs) {
            // Se asume que song.contentQuizData.questions tiene la estructura: 
            // { q: pregunta, a: respuesta_correcta, d: [distractor1, distractor2, distractor3] }
            if (!song.contentQuizData || !song.contentQuizData.questions || song.contentQuizData.questions.length < 5) {
                return '<p class="text-red-400">Error: No hay suficientes datos para generar las preguntas de contenido para esta obra.</p>';
            }
            
            const quizQuestionsData = song.contentQuizData.questions;
            const selectedQuestions = shuffleArray([...quizQuestionsData]).slice(0, 5); // Aseguramos 5 preguntas aleatorias

            let quizHtml = '';
            selectedQuestions.forEach((qData, index) => {
                const questionNumber = index + 1;
                const question = qData.q;
                const correctAnswer = qData.a;
                const distractors = qData.d;
                
                // Crea el array de opciones (respuesta correcta + distractores)
                let finalOptions = shuffleArray([correctAnswer, ...distractors]);
                
                // Asegura un m√°ximo de 4 opciones (1 correcta + 3 distractores) y baraja
                if (finalOptions.length > 4) {
                     finalOptions = shuffleArray(finalOptions.filter(opt => opt !== correctAnswer)).slice(0, 3);
                     finalOptions.push(correctAnswer);
                }
                
                // Vuelve a barajar las opciones finales para que la correcta no siempre est√© al final
                const shuffledOptions = shuffleArray(finalOptions);

                const optionsHtml = shuffledOptions.map((option) => `
                    <label class="flex items-center p-3 bg-indigo-700/50 rounded-lg hover:bg-indigo-600 transition cursor-pointer">
                        <input type="radio" name="question${questionNumber}" value="${option}" class="form-radio h-5 w-5 text-red-400">
                        <span class="ml-3 text-lg">${option}</span>
                    </label>
                `).join('');

                quizHtml += `
                    <div class="p-4 bg-indigo-800 rounded-xl border border-indigo-600 shadow-inner">
                        <p class="text-xl font-semibold mb-4 text-yellow-300">Pregunta ${questionNumber}: ${question}</p>
                        <div class="space-y-2">
                            ${optionsHtml}
                        </div>
                        <input type="hidden" id="correctAnswer${questionNumber}" value="${correctAnswer}">
                    </div>
                `;
            });
            
            return quizHtml;
        }


        function openQuizModal(songId) {
            const song = songs.find(s => s.id === songId);
            if (!song) return;
            
            selectedSongId = songId;
            
            document.getElementById('quizTitle').textContent = `Quiz: ¬øQu√© sabes de "${song.title}"?`;
            const quizContent = document.getElementById('quizContent');
            quizContent.innerHTML = ''; 

            quizContent.innerHTML = generateQuizQuestions(song, songs) + `
                <div class="flex justify-end">
                    <button onclick="submitQuiz()" class="bg-red-500 hover:bg-red-600 px-6 py-3 rounded-lg font-bold transition-all text-lg hover:scale-105">
                        Finalizar Quiz
                    </button>
                </div>
            `;

            document.getElementById('quizModal').classList.remove('hidden');
        }

        function submitQuiz() {
            const songIndex = songs.findIndex(s => s.id === selectedSongId);
            const song = songs[songIndex];
            if (!song) return;

            let correctAnswers = 0;
            const totalQuestions = 5;

            for (let i = 1; i <= totalQuestions; i++) {
                const selectedOption = document.querySelector(`input[name="question${i}"]:checked`);
                const correctAnswer = document.getElementById(`correctAnswer${i}`).value;

                if (selectedOption && selectedOption.value === correctAnswer) {
                    correctAnswers++;
                }
            }

            // 1. C√°lculo de estrellas y diamante
            let starsGained = correctAnswers * 5;
            let bonus = 0;
            let unlockMessage = '';

            // Ya no desbloquea A√±o/G√©nero, solo impide que se haga de nuevo
            if (correctAnswers >= 1 && !song.unlocked) {
                song.unlocked = true; 
                unlockMessage = '<p class="font-bold text-teal-400 mt-2">¬°Quiz registrado! Gracias por participar.</p>';
            }

            if (correctAnswers === totalQuestions) {
                bonus = 10;
                starsGained += bonus;
                song.hasDiamond = true; // NUEVO: Gana diamante
                unlockMessage += '<p class="font-bold text-yellow-300 mt-2">¬°BONIFICACI√ìN! +10 Estrellas por acierto completo (5/5). ¬°Has ganado un <span class="text-white">DIAMANTE</span> üíé!</p>';
            }

            // 2. Actualizar saldo del usuario
            userStars += starsGained;
            document.getElementById('userStarsDisplay').textContent = userStars;

            // 3. Mostrar resultado
            const resultHtml = `
                <div class="text-center p-6 bg-indigo-700 rounded-xl border-2 border-red-400">
                    <h3 class="text-3xl font-bold text-white mb-4">¬°Resultado del Quiz!</h3>
                    <p class="text-2xl font-semibold text-cyan-400">Respuestas Correctas: ${correctAnswers} de ${totalQuestions}</p>
                    <p class="text-xl mt-4 text-yellow-400">Ganaste: <span class="font-bold text-3xl">${starsGained}</span> Estrellas ‚≠ê</p>
                    ${unlockMessage}
                    <p class="text-lg mt-4 text-white">Tu nuevo saldo es: <span class="font-bold text-yellow-400">${userStars}</span> Estrellas.</p>
                </div>
            `;

            document.getElementById('quizContent').innerHTML = resultHtml;

            // 4. Guardar datos y actualizar ranking visual
            saveAppData();
            renderRanking();
            
            // Reemplazar el bot√≥n de finalizar con uno de cerrar
            document.getElementById('quizContent').innerHTML += `
                <div class="flex justify-end pt-4">
                    <button onclick="closeQuizModal()" class="bg-indigo-500 hover:bg-indigo-600 px-6 py-3 rounded-lg font-bold transition-all text-lg hover:scale-105">
                        Cerrar
                    </button>
                </div>
            `;
        }


        function closeQuizModal() {
            document.getElementById('quizModal').classList.add('hidden');
            selectedSongId = null;
        }

        // --- INICIALIZACI√ìN ---

        function init() {
            loadAppData(); 
            checkAndResetWeeklyData(); 
            renderRanking(); 
            
            // Listeners para cerrar modales al hacer clic fuera
            document.getElementById('infoModal').addEventListener('click', function(e) {
                if (e.target === this) closeInfoModal();
            });

            document.getElementById('lyricsModal').addEventListener('click', function(e) {
                if (e.target === this) closeLyricsModal(); 
            });

            document.getElementById('quizModal').addEventListener('click', function(e) {
                if (e.target === this) closeQuizModal(); 
            });
            
            document.getElementById('globalInfoModal').addEventListener('click', function(e) {
                if (e.target === this) closeGlobalInfoModal(); 
            });
            
            document.getElementById('missionModal').addEventListener('click', function(e) {
                if (e.target === this) closeMissionModal(); 
            });
            
            document.getElementById('voteSelectionModal').addEventListener('click', function(e) {
                if (e.target === this) closeVoteSelectionModal(); 
            });
            
            // Cierra el men√∫ desplegable si se hace click fuera
            document.addEventListener('click', function(e) {
                const profileDropdown = document.getElementById('profileDropdown');
                const profileMenuContainer = document.getElementById('profileMenuContainer');
                
                if (profileDropdown && !profileMenuContainer.contains(e.target) && !profileDropdown.classList.contains('hidden')) {
                    profileDropdown.classList.add('hidden');
                }
            });
        }

        // Ejecutar la inicializaci√≥n al cargar la p√°gina
        window.onload = init;
    </script>
</body>
</html>
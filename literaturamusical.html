<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala 1 - Literatura Musical</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @keyframes pulse-custom { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.3; } }
        @keyframes bounce-custom { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes blink-custom { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-custom { animation: pulse-custom 3s ease-in-out infinite; }
        .animate-bounce-custom { animation: bounce-custom 2s ease-in-out infinite; }
        .animate-blink-custom { animation: blink-custom 1s step-start infinite; }
        @keyframes bounce-sala1 { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-bounce-sala1 { animation: bounce-sala1 1.5s ease-in-out infinite; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    
    <header class="bg-purple-950 p-4 shadow-xl sticky top-0 z-10 border-b border-purple-800">
        <div class="container mx-auto flex flex-col items-center">
            
            <h1 class="text-xl md:text-3xl font-extrabold text-lime-400 flex items-center justify-center w-full mb-2">
                <svg class="w-6 h-6 md:w-8 md:h-8 mr-2 text-yellow-400 animate-bounce-sala1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
                </svg>
                Sala Literatura Musical
            </h1>
            
            <div class="w-full flex justify-between items-center mb-2 md:mb-4">
                 <div class="flex items-center space-x-4 text-sm md:text-lg font-bold text-white">
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-hand-pointer text-cyan-400 text-lg"></i>
                        <span id="votesRemainingDisplay" class="text-yellow-400">5</span>
                    </div>
                    <span class="text-cyan-400 hidden sm:inline-block">|</span>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-star text-yellow-400 text-lg"></i>
                        <span id="userStarsDisplay" class="text-yellow-400">0</span>
                    </div>
                    <span class="text-cyan-400 hidden sm:inline-block">|</span>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-gem text-teal-400 text-lg"></i>
                        <span id="totalDiamondsDisplay" class="text-yellow-400">0</span>
                    </div>
                 </div>
                 <div class="flex items-center space-x-2 md:space-x-4">
                    <button onclick="openGlobalInfoModal()" class="bg-purple-700 hover:bg-purple-600 p-2 rounded-full transition-all hover:scale-105">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                    <a href="perfil.html" class="bg-emerald-600 hover:bg-emerald-700 p-2 rounded-full transition-all hover:scale-105" title="Ir a Perfil">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </a>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-4 w-full justify-center">
                <a href="temas.html" class="bg-yellow-500 text-gray-900 hover:bg-yellow-600 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Volver a Temas</a>
            </div>
            
            <p class="text-center text-lg md:text-xl font-medium text-lime-300 mt-4 px-4">
                Elige 5 canciones que m√°s te gusten para competir por el tercer, segundo y primer puesto.
            </p>
        </div>
    </header>
    
    <main class="container mx-auto p-6">
        <section class="mb-12">
            <h2 class="text-4xl font-extrabold text-center mb-8 text-yellow-400 drop-shadow-lg">üèÜ Top 3: Lo m√°s votado üèÜ</h2>
            <div id="top3Container" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
        </section>
        <section>
            <h2 class="text-3xl font-bold text-center mb-8 text-teal-400">Resto del Ranking</h2>
            <div id="rankingContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
    </main>

    <div id="quizModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-red-900 rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto border-2 border-red-400 shadow-2xl">
            <div class="sticky top-0 bg-purple-900 p-4 flex justify-between items-center border-b border-purple-700">
                <h2 class="text-2xl font-bold text-red-400" id="quizTitle">Quiz de la Canci√≥n</h2>
                <button onclick="closeQuizModal()" class="hover:bg-purple-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="quizContent" class="p-6 text-white space-y-6">
                </div>
        </div>
    </div>
    
    <div id="voteModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-purple-900 to-emerald-900 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto border-2 border-emerald-400 shadow-2xl">
            <div class="sticky top-0 bg-purple-900 p-4 flex justify-between items-center border-b border-purple-700">
                <h2 class="text-2xl font-bold text-emerald-400" id="voteTitle">Votar por Canci√≥n</h2>
                <button onclick="closeVoteSelectionModal()" class="hover:bg-purple-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 text-white space-y-4">
                <p class="text-lg text-center font-semibold mb-4">Selecciona cu√°ntas estrellas ‚≠ê quieres usar para votar por: <span id="songTitleForVote" class="text-yellow-400 font-bold"></span></p>
                <p class="text-sm text-center text-gray-300">Votos restantes: <span id="currentVotesRemaining" class="text-yellow-400 font-bold">5</span> | Estrellas actuales: <span id="currentUserStars" class="text-yellow-400 font-bold">0</span></p>
                
                <div class="grid grid-cols-2 gap-3" id="starOptionsContainer">
                    </div>
                
                <div id="voteMessage" class="mt-4 text-center text-red-400 font-semibold hidden"></div>

                <div class="flex justify-end pt-4">
                    <button onclick="submitVote()" id="submitVoteButton" class="bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-lg font-bold text-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                        Confirmar Voto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-purple-950 p-4 shadow-inner mt-12 border-t border-purple-800">
        <div class="container mx-auto flex justify-center items-center">
            <a href="https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB" target="_blank" class="text-red-400 hover:text-red-500 font-semibold flex items-center gap-2 transition-all">
                <svg class="w-8 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21.582,6.186c-0.23-0.814-0.814-1.398-1.628-1.628C18.309,4,12,4,12,4S5.691,4,4.046,4.558C3.232,4.788,2.648,5.372,2.418,6.186C1.86,7.831,1.86,12,1.86,12s0,4.169,0.558,5.814c0.23,0.814,0.814,1.398,1.628,1.628C5.691,20,12,20,12,20s6.309,0,7.954-0.558c0.814-0.23,1.398-0.814,1.628-1.628C22.14,16.169,22.14,12,22.14,12S22.14,7.831,21.582,6.186z M10,15.464V8.536L16,12L10,15.464z"></path>
                </svg>
                Visita nuestro canal en YouTube
            </a>
        </div>
    </footer>

    <script>
        var initialSongs = [
            { id: 1, title: "El lenguaje del mundo", author: "Paulo Coelho", year: 1988, genre: "F√°bula / Aventura", image: "imagenportada/lit_alquimista.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/lit_alquimista.mp3", description: "Basada en (El Alquimista). Santiago, un pastor andaluz, viaja a las pir√°mides de Egipto en busca de un tesoro.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øCu√°l es el nombre del protagonista?", a: "Santiago", d: ["Melquisedec", "F√°tima", "El Ingl√©s"] }, { q: "¬øQu√© le dice el Rey de Salem que debe seguir?", a: "Su Leyenda Personal", d: ["El Idioma del Mundo", "El Maktub", "La Voluntad de Dios"] }, { q: "¬øD√≥nde est√° el verdadero tesoro?", a: "Bajo un sicomoro en una iglesia en ruinas en Andaluc√≠a", d: ["En las pir√°mides", "En un oasis", "En un cofre enterrado en el desierto"] }, { q: "¬øQu√© debe hacer Santiago para transformarse en viento?", a: "Escuchar a su coraz√≥n", d: ["Hablar con el sol", "Caminar descalzo", "Recitar un conjuro"] }, { q: "¬øCu√°l es el 'gran enga√±o' que le advierte el Alquimista?", a: "El tesoro prometido est√° en realidad en el desierto", d: ["El amor es una ilusi√≥n", "El oro se vuelve ceniza", "Dios existe para el que lo busca"] } ] } },
            { id: 2, title: "El ciclo de Macondo", author: "Gabriel Garc√≠a M√°rquez", year: 1967, genre: "Realismo M√°gico", image: "imagenportada/lit_cien_anios.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/lit_cien_anios.mp3", description: "Basada en (Cien a√±os de soledad). La historia de la familia Buend√≠a a lo largo de siete generaciones en el pueblo de Macondo.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øC√≥mo se llama el pueblo fundado por Jos√© Arcadio Buend√≠a?", a: "Macondo", d: ["Acapulco", "Puebloviejo", "Cienfuegos"] }, { q: "¬øQu√© pariente tiene cola de cerdo?", a: "Aureliano Babilonia", d: ["√örsula Iguar√°n", "Coronel Aureliano Buend√≠a", "Remedios la bella"] }, { q: "¬øQui√©n predijo el destino de la familia Buend√≠a?", a: "Melqu√≠ades", d: ["Pilar Ternera", "Meme", "Arcadio"] }, { q: "¬øQu√© personaje es ascendido al cielo mientras cuelga la s√°bana?", a: "Remedios la bella", d: ["√örsula Iguar√°n", "Amaranta", "Rebeca"] }, { q: "¬øC√≥mo termina la saga de los Buend√≠a?", a: "Con la lectura de un pergamino que predice su extinci√≥n", d: ["Con una gran inundaci√≥n", "Con el regreso de los gitanos", "Con el nacimiento de un ni√±o sin cola"] } ] } },
            { id: 3, title: "El ojo que todo lo ve", author: "George Orwell", year: 1949, genre: "Distop√≠a / Ciencia Ficci√≥n", image: "imagenportada/lit_1984.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/lit_1984.mp3", description: "Basada en (1984). Winston Smith vive en un mundo totalitario bajo la vigilancia constante del 'Gran Hermano'.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øQui√©n es la figura omnipresente que vigila a todos?", a: "El Gran Hermano", d: ["Emmanuel Goldstein", "O'Brien", "El Partido Interior"] }, { q: "¬øCu√°l es el nombre del pa√≠s donde vive el protagonista?", a: "Ocean√≠a", d: ["Eurasia", "Estasia", "Ingsoc"] }, { q: "¬øCu√°l es el lema del Partido?", a: "La guerra es paz, la libertad es esclavitud, la ignorancia es fuerza", d: ["Piensa antes de actuar", "El amor es odio", "El futuro es nuestro"] }, { q: "¬øC√≥mo se llama el lenguaje que el Partido est√° creando para limitar el pensamiento?", a: "Neolengua (Newspeak)", d: ["Doblepiensa", "Vieja habla", "Ingsoc"] }, { q: "¬øEn qu√© sala torturan a Winston para que traicione a Julia?", a: "Sala 101", d: ["La Sala de la Verdad", "La Sala de la Memoria", "El Ministerio del Amor"] } ] } },
            { id: 4, title: "La Fiebre de San Petersburgo", author: "Fi√≥dor Dostoievski", year: 1866, genre: "Novela Psicol√≥gica", image: "imagenportada/lit_crimen.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/lit_crimen.mp3", description: "Basada en (Crimen y castigo).Un estudiante pobre, Rask√≥lnikov, comete un asesinato y lucha con su culpa.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øC√≥mo se llama el protagonista, que comete el crimen?", a: "Rodi√≥n Rask√≥lnikov", d: ["Dimitri Karam√°zov", "Iv√°n Bezdomny", "Svidrig√°ilov"] }, { q: "¬øA qui√©n asesina Rask√≥lnikov?", a: "A una vieja usurera y a su hermana", d: ["A su casera", "A un polic√≠a", "A su rival"] }, { q: "¬øQu√© teor√≠a filos√≥fica intenta justificar el crimen de Rask√≥lnikov?", a: "Que los hombres extraordinarios tienen derecho a transgredir las leyes", d: ["El nihilismo", "El utilitarismo", "El existencialismo"] }, { q: "¬øQui√©n es Sonia Marmel√°dova?", a: "Una joven prostituta de buen coraz√≥n", d: ["La prometida de Rask√≥lnikov", "Una monja", "La madre de Rask√≥lnikov"] }, { q: "¬øEn qu√© ciudad transcurre la mayor parte de la novela?", a: "San Petersburgo", d: ["Mosc√∫", "Kiev", "Odesa"] } ] } },
            { id: 5, title: "El Matrimonio Bennet", author: "Jane Austen", year: 1813, genre: "Novela Rom√°ntica", image: "imagenportada/lit_orgullo.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/lit_orgullo.mp3", description: "Basada en (Orgullo y prejuicio). Elizabeth Bennet y el Sr. Darcy luchan contra el orgullo y los prejuicios sociales.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øC√≥mo se llama la hero√≠na de la novela?", a: "Elizabeth Bennet", d: ["Jane Bennet", "Lydia Bennet", "Kitty Bennet"] }, { q: "¬øC√≥mo se llama el pretendiente de Jane, la hermana mayor?", a: "Sr. Bingley", d: ["Sr. Collins", "Sr. Wickham", "Sr. Darcy"] }, { q: "¬øCu√°l es el primer error que comete Elizabeth al juzgar a Darcy?", a: "Lo considera orgulloso", d: ["Lo considera pobre", "Lo considera demasiado joven", "Lo considera un libertino"] }, { q: "¬øQui√©n es el coronel Fitzwilliam?", a: "El primo de Mr. Darcy", d: ["El hermano de Mr. Bingley", "El padre de Mr. Darcy", "Un pretendiente de Elizabeth"] }, { q: "¬øCu√°l es el nombre de la propiedad de Mr. Darcy?", a: "Pemberley", d: ["Netherfield", "Longbourn", "Rosings"] } ] } },
            { id: 6, title: "Contra molinos y gigantes", author: "Miguel de Cervantes", year: 1605, genre: "Novela de Caballer√≠as / S√°tira", image: "imagenportada/lit_quijote.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/lit_quijote.mp3", description: "Basada en (Don Quijote de la Mancha. Un hidalgo enloquece al leer libros de caballer√≠as y se lanza a la aventura como caballero andante.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øQui√©n es el fiel escudero de Don Quijote?", a: "Sancho Panza", d: ["Rocinante", "Dulcinea", "Maese Nicol√°s"] }, { q: "¬øCu√°l es el verdadero nombre de Don Quijote?", a: "Alonso Quijano", d: ["Cide Hamete Benengeli", "Pedro P√©rez", "Nicol√°s Zafra"] }, { q: "¬øA qui√©n dedica Don Quijote sus haza√±as?", a: "Dulcinea del Toboso", d: ["La Dama del Lago", "La Reina de Sab√°", "La Condesa de Naranja"] }, { q: "¬øQu√© confunde Don Quijote con gigantes?", a: "Molinos de viento", d: ["√Årboles viejos", "Reba√±os de ovejas", "V√≠rgenes guerreras"] }, { q: "¬øC√≥mo se llama el caballo de Don Quijote?", a: "Rocinante", d: ["Bucefalo", "Babieca", "Pegaso"] } ] } },
            { id: 7, title: "El sol, la playa y la sinceridad", author: "Albert Camus", year: 1942, genre: "Novela Filos√≥fica / Existencialismo", image: "imagenportada/lit_extranjero.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/lit_extranjero.mp3", description: "Basada en "El extranjero. Meursault asiste al funeral de su madre y, poco despu√©s, comete un asesinato indiferente al sol.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øC√≥mo se llama el protagonista?", a: "Meursault", d: ["Rieux", "Tarrou", "Bernadette"] }, { q: "¬øCu√°l es la primera frase famosa de la novela?", a: "Hoy, mam√° ha muerto", d: ["He decidido ser feliz", "La vida no tiene sentido", "El sol brillaba fuertemente"] }, { q: "¬øPor qu√© dice Meursault que dispar√≥ al √°rabe?", a: "Por el sol", d: ["Por el alcohol", "Por defensa propia", "Por la indiferencia"] }, { q: "¬øQu√© sensaci√≥n domina la vida de Meursault?", a: "La indiferencia (o el absurdo)", d: ["La pasi√≥n", "La culpa", "El miedo"] }, { q: "¬øMeursault llora en el funeral de su madre?", a: "No", d: ["S√≠", "Solo un poco", "Lo intenta pero no puede"] } ] } },
            { id: 8, title: "La Odisea", author: "Homero", year: "Siglo VIII a.C.", genre: "Poema √âpico", image: "imagenportada/lit_odisea.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/lit_odisea.mp3", description: "El viaje de regreso de Odiseo a √çtaca, lleno de monstruos, dioses y peligros.", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øC√≥mo se llama el protagonista, rey de √çtaca?", a: "Odiseo", d: ["Aquiles", "Agamen√≥n", "H√©ctor"] }, { q: "¬øQu√© monstruo marino tiene un solo ojo?", a: "Polifemo (C√≠clope)", d: ["Escila", "Caribdis", "La Hidra"] }, { q: "¬øQu√© diosa ayuda a Odiseo en su regreso?", a: "Atenea", d: ["Hera", "Afrodita", "Artemisa"] }, { q: "¬øQui√©n es la esposa fiel de Odiseo?", a: "Pen√©lope", d: ["Calipso", "Circe", "Naus√≠caa"] }, { q: "¬øQu√© hace Odiseo a los pretendientes que asedian su casa?", a: "Los mata a todos con ayuda de su hijo", d: ["Los perdona", "Los expulsa", "Los envenena"] } ] } },
            { id: 9, title: "Pr√≥ximamente", author: "???", year: "????", genre: "???", image: "", totalStars: 0, comingSoon: true },
            { id: 10, title: "Pr√≥ximamente", author: "???", year: "????", genre: "???", image: "", totalStars: 0, comingSoon: true },
            { id: 11, title: "Pr√≥ximamente", author: "???", year: "????", genre: "???", image: "", totalStars: 0, comingSoon: true },
            { id: 12, title: "Pr√≥ximamente", author: "???", year: "????", genre: "???", image: "", totalStars: 0, comingSoon: true }
        ];

        var songs = []; 
        var votesRemaining = 5; 
        var userStars = 0; 
        var totalDiamonds = 0;
        var selectedSongId = null; 
        var selectedSongIdForVote = null; 
        var selectedStarsForVote = 0; 
        
        // ** NUEVAS CONSTANTES Y FUNCIONES GLOBALES PARA EL PERFIL **
        const GLOBAL_SELECTED_SONGS_KEY = 'selectedSongsGlobal';
        const MAX_SELECTED_SONGS = 5;
        const ROOM_IDENTIFIER = 'literatura'; 

        function getGlobalSelectedSongs() {
            return JSON.parse(localStorage.getItem(GLOBAL_SELECTED_SONGS_KEY) || '[]');
        }

        function saveGlobalSelectedSongs(songs) {
            localStorage.setItem(GLOBAL_SELECTED_SONGS_KEY, JSON.stringify(songs));
        }
        // ** FIN NUEVAS FUNCIONES GLOBALES **

        // Valores de votaci√≥n permitidos
        const VOTE_AMOUNTS = [5, 6, 7, 8, 9, 10]; 
        
        // Variable para manejar la reproducci√≥n de un solo audio
        let currentlyPlayingAudio = null;

        function saveAppData() {
            localStorage.setItem('literaturamusical_songs', JSON.stringify(songs));
            localStorage.setItem('literaturamusical_votesRemaining', votesRemaining); 
            localStorage.setItem('literaturamusical_userStars', userStars); 
            localStorage.setItem('literaturamusical_totalDiamonds', totalDiamonds);
        }

        function loadAppData() {
            const savedSongs = localStorage.getItem('literaturamusical_songs');
            songs = savedSongs ? JSON.parse(savedSongs) : initialSongs;
            votesRemaining = parseInt(localStorage.getItem('literaturamusical_votesRemaining') || '5');
            userStars = parseInt(localStorage.getItem('literaturamusical_userStars') || '0');
            totalDiamonds = parseInt(localStorage.getItem('literaturamusical_totalDiamonds') || '0');

            let diamondRecount = 0;
            songs = songs.map(song => {
                const initial = initialSongs.find(s => s.id === song.id);
                if (typeof song.quizStars === 'undefined') song.quizStars = 0;
                if (song.hasDiamond) diamondRecount++;
                if (initial) song.contentQuizData = initial.contentQuizData;
                return song;
            });

            if (totalDiamonds !== diamondRecount) totalDiamonds = diamondRecount;
            updateHeaderDisplays();
        }
        
        // ** FUNCI√ìN DE SELECCI√ìN ACTUALIZADA PARA EL L√çMITE GLOBAL **
        function selectSongForProfile(songId) {
            const song = songs.find(s => s.id === songId);
            let globalSelectedSongs = getGlobalSelectedSongs();

            if (!song || !song.listened) {
                if(!song.listened) alert("Debes escuchar la canci√≥n antes de elegirla.");
                return;
            }
            
            // 1. Check if song is already selected (globally, using the unique room+id combo)
            if (globalSelectedSongs.some(s => s.room === ROOM_IDENTIFIER && s.id === songId)) {
                alert(`"${song.title}" ya ha sido elegida.`);
                return;
            }

            // 2. Check global limit
            if (globalSelectedSongs.length >= MAX_SELECTED_SONGS) {
                alert(`Ya tienes el m√°ximo de ${MAX_SELECTED_SONGS} canciones elegidas. Elimina una de Perfil para a√±adir otra.`);
                return;
            }

            // 3. Add the song with its room identifier
            globalSelectedSongs.push({
                id: song.id, 
                title: song.title, 
                author: song.author, 
                image: song.image,
                room: ROOM_IDENTIFIER, // Agrega el identificador de sala
                hasDiamond: song.hasDiamond, 
                quizStars: song.quizStars || 0
            });
            
            saveGlobalSelectedSongs(globalSelectedSongs);
            renderRanking(); // Re-render para actualizar el bot√≥n 'Elegir'
            alert(`¬°"${song.title}" ha sido elegida para tu perfil√©!`);
        }
        
        // --- FUNCIONES DEL QUIZ ---
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateQuizQuestions(song) {
            if (!song.contentQuizData || !song.contentQuizData.questions || song.contentQuizData.questions.length < 5) {
                return '<p class="text-red-400">Error: No hay suficientes preguntas para esta canci√≥n.</p>';
            }
            
            const selectedQuestions = shuffleArray([...song.contentQuizData.questions]).slice(0, 5);
            let quizHtml = '';
            selectedQuestions.forEach((qData, index) => {
                const qNum = index + 1;
                const options = shuffleArray([qData.a, ...qData.d]);
                const optionsHtml = options.map(opt => `
                    <label class="flex items-center p-3 bg-purple-700/50 rounded-lg hover:bg-purple-600 cursor-pointer">
                        <input type="radio" name="question${qNum}" value="${opt}" class="form-radio h-5 w-5 text-red-400">
                        <span class="ml-3 text-lg">${opt}</span>
                    </label>
                `).join('');

                quizHtml += `
                    <div class="p-4 bg-purple-800 rounded-xl border border-purple-600" data-q-original="${qData.q}" data-q-correct="${qData.a}">
                        <p class="text-xl font-semibold mb-4 text-yellow-300">Pregunta ${qNum}: ${qData.q}</p>
                        <div class="space-y-2">${optionsHtml}</div>
                        <input type="hidden" id="correctAnswer${qNum}" value="${qData.a}">
                    </div>
                `;
            });
            return quizHtml;
        }

        function openQuizModal(id){
            selectedSongId = id;
            const song = songs.find(s => s.id === id);
            if (!song) return;

            document.getElementById('quizTitle').textContent = `Quiz: ¬øQu√© sabes de "${song.title}"?`;
            const quizContent = document.getElementById('quizContent');
            quizContent.innerHTML = generateQuizQuestions(song) + `
                <div class="flex justify-end pt-6">
                    <button onclick="submitQuiz()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold text-lg">
                        Finalizar Quiz
                    </button>
                </div>
            `;
            document.getElementById('quizModal').classList.remove('hidden');
        }

        function closeQuizModal() {
            document.getElementById('quizModal').classList.add('hidden');
            selectedSongId = null;
        }

        function submitQuiz() {
            const songIndex = songs.findIndex(s => s.id === selectedSongId);
            if (songIndex === -1) return;

            let correctAnswers = 0;
            const totalQuestions = 5;
            let resultDetailsHtml = '';

            for (let i = 1; i <= totalQuestions; i++) {
                const questionDiv = document.querySelector(`#quizContent > div:nth-child(${i})`);
                if (!questionDiv) continue;
                
                const questionText = questionDiv.getAttribute('data-q-original');
                const selectedInput = document.querySelector(`input[name="question${i}"]:checked`);
                const userAnswer = selectedInput ? selectedInput.value : 'No contestada';
                const correctAnswer = questionDiv.getAttribute('data-q-correct');
                const isCorrect = userAnswer === correctAnswer;
                
                if (isCorrect) correctAnswers++;

                resultDetailsHtml += `
                    <div class="p-3 rounded-lg border ${isCorrect ? 'border-green-500 bg-green-900/50' : 'border-red-500 bg-red-900/50'}">
                        <p class="font-bold text-lg mb-1 text-yellow-300">P. ${i}: ${questionText}</p>
                        <p class="text-sm">Tu Respuesta: <span class="${isCorrect ? 'text-green-300' : 'text-red-300 font-bold'}">${userAnswer} ${isCorrect ? '‚úÖ' : '‚ùå'}</span></p>
                        ${!isCorrect ? `<p class="text-sm">Correcta: <span class="text-cyan-300 font-bold">${correctAnswer}</span></p>` : ''}
                    </div>
                `;
            }

            let starsGained = correctAnswers * 5;
            let resultMessage = '';

            if (correctAnswers === totalQuestions) {
                starsGained += 10; // Bonus
                if (!songs[songIndex].hasDiamond) {
                    songs[songIndex].hasDiamond = true;
                    totalDiamonds++;
                }
                resultMessage = `<p class="font-bold text-yellow-300 mt-2 text-xl">¬°PERFECTO! +10 Estrellas de bonificaci√≥n. ¬°Has ganado un üíé!</p>`;
            } else {
                 resultMessage = `<p class="font-bold text-yellow-300 mt-2">¬°Sigue practicando para mejorar!</p>`;
            }

            songs[songIndex].quizStars = starsGained;
            userStars += starsGained;
            songs[songIndex].unlocked = true; 
            
            const quizContent = document.getElementById('quizContent');
            quizContent.innerHTML = `
                <div class="text-center p-6 bg-purple-700 rounded-xl mb-4">
                    <h3 class="text-3xl font-bold mb-4">¬°Resultado!</h3>
                    <p class="text-2xl font-semibold text-cyan-400">Respuestas Correctas: ${correctAnswers} de ${totalQuestions}</p>
                    <p class="text-xl mt-4 text-yellow-400">Estrellas ganadas: <span class="font-bold text-3xl">${starsGained}</span> ‚≠ê</p>
                    ${resultMessage}
                </div>
                <h4 class="text-2xl font-bold text-teal-400 mb-3 border-b border-teal-400 pb-2">Detalle de Respuestas</h4>
                <div class="space-y-3">${resultDetailsHtml}</div>
                <div class="flex justify-end pt-4">
                    <button onclick="closeQuizModal()" class="bg-purple-500 hover:bg-purple-600 px-6 py-3 rounded-lg font-bold text-lg">Cerrar</button>
                </div>
            `;

            saveAppData();
            renderRanking();
            updateHeaderDisplays();
        }

        // --- FUNCIONES DE AUDIO ---
        
        function playAudio(songId) {
            const audioPlayer = document.getElementById(`audioPlayer${songId}`);
            if (!audioPlayer) return;

            if (audioPlayer.paused) {
                if (currentlyPlayingAudio && currentlyPlayingAudio !== audioPlayer) {
                    currentlyPlayingAudio.pause();
                    const previousId = parseInt(currentlyPlayingAudio.id.replace('audioPlayer', ''));
                    resetPlayButton(previousId);
                }
                audioPlayer.play().catch(error => {
                    console.error("Error al intentar reproducir audio:", error);
                    resetPlayButton(songId); 
                });
                markAsListened(songId);
                updatePlayButton(songId, true);
                currentlyPlayingAudio = audioPlayer;
            } else {
                audioPlayer.pause();
                updatePlayButton(songId, false);
                currentlyPlayingAudio = null;
            }
        }

        function stopAudio(songId) {
            const audioPlayer = document.getElementById(`audioPlayer${songId}`);
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                updatePlayButton(songId, false);
                if (currentlyPlayingAudio === audioPlayer) {
                    currentlyPlayingAudio = null;
                }
            }
        }
        
        function updatePlayButton(songId, isPlaying) {
             const playButton = document.getElementById(`playButton${songId}`);
             const stopButton = document.getElementById(`stopButton${songId}`);
             const listeningText = document.getElementById(`listeningText${songId}`);
             if (playButton && stopButton && listeningText) {
                 if (isPlaying) {
                    playButton.innerHTML = '<i class="fas fa-pause text-xl"></i>';
                    stopButton.classList.remove('hidden');
                    listeningText.classList.remove('hidden');
                 } else {
                    playButton.innerHTML = '<i class="fas fa-play text-xl"></i>';
                    stopButton.classList.add('hidden');
                    listeningText.classList.add('hidden');
                 }
             }
        }

        function resetPlayButton(songId) {
             updatePlayButton(songId, false);
             if (currentlyPlayingAudio && currentlyPlayingAudio.id === `audioPlayer${songId}`) {
                 currentlyPlayingAudio = null;
             }
             renderRanking();
        }

        function markAsListened(songId) {
            const song = songs.find(s => s.id === songId);
            if(song && !song.listened) {
                song.listened = true;
                saveAppData();
            }
        }
        
        // --- FUNCIONES DE VOTO ---

        function openVoteSelectionModal(id) {
            selectedSongIdForVote = id;
            selectedStarsForVote = 0;
            const song = songs.find(s => s.id === id);
            if (!song) return;

            document.getElementById('songTitleForVote').textContent = `"${song.title}"`;
            document.getElementById('currentVotesRemaining').textContent = votesRemaining;
            document.getElementById('currentUserStars').textContent = userStars;
            document.getElementById('voteMessage').classList.add('hidden');
            document.getElementById('submitVoteButton').disabled = true;

            const starOptionsContainer = document.getElementById('starOptionsContainer');
            starOptionsContainer.innerHTML = '';

            VOTE_AMOUNTS.forEach(stars => {
                const canAfford = userStars >= stars;
                const disabledClass = !canAfford ? 'bg-gray-700/50 cursor-not-allowed opacity-50' : 'bg-emerald-700/50 hover:bg-emerald-600 cursor-pointer';
                const label = document.createElement('label');
                label.className = `flex items-center justify-center p-3 rounded-lg transition-all border border-emerald-500 ${disabledClass}`;
                label.innerHTML = `
                    <input type="radio" name="voteStars" value="${stars}" class="hidden" onchange="handleStarSelection(${stars})" ${!canAfford ? 'disabled' : ''}>
                    <span class="text-xl font-bold flex items-center">
                        ${stars} <i class="fas fa-star ml-2 text-yellow-400"></i>
                    </span>
                `;
                starOptionsContainer.appendChild(label);
            });

            document.getElementById('voteModal').classList.remove('hidden');
        }

        function closeVoteSelectionModal() {
            document.getElementById('voteModal').classList.add('hidden');
            selectedSongIdForVote = null;
            selectedStarsForVote = 0;
        }

        function handleStarSelection(stars) {
            selectedStarsForVote = stars;
            const submitButton = document.getElementById('submitVoteButton');
            const message = document.getElementById('voteMessage');

            if (votesRemaining <= 0) {
                message.textContent = "No tienes votos restantes.";
                message.classList.remove('hidden');
                submitButton.disabled = true;
            } else if (userStars < selectedStarsForVote) {
                message.textContent = `Necesitas ${selectedStarsForVote} ‚≠ê para votar con esta opci√≥n.`;
                message.classList.remove('hidden');
                submitButton.disabled = true;
            } else {
                message.classList.add('hidden');
                submitButton.disabled = false;
            }
        }

        function submitVote() {
            if (votesRemaining <= 0) {
                alert("¬°No tienes votos restantes!"); return;
            }
            if (selectedStarsForVote === 0 || userStars < selectedStarsForVote) {
                alert("Por favor, selecciona una cantidad de estrellas v√°lida para votar."); return;
            }
            const songIndex = songs.findIndex(s => s.id === selectedSongIdForVote);
            if (songIndex === -1) return;
            votesRemaining--;
            userStars -= selectedStarsForVote;
            songs[songIndex].totalStars += selectedStarsForVote;
            alert(`¬°Voto exitoso! Usaste ${selectedStarsForVote} ‚≠ê para votar por "${songs[songIndex].title}".`);
            saveAppData();
            updateHeaderDisplays();
            renderRanking();
            closeVoteSelectionModal();
        }
        
        // --- RENDERIZADO (Actualizado para el bot√≥n 'Elegir' y la l√≥gica global) ---

        function createSongCard(song, position, isTop3 = false) {
            if (song.comingSoon) {
                return `
                    <div class="bg-gray-800 border border-dashed border-gray-600 rounded-xl overflow-hidden shadow-lg relative flex flex-col items-center justify-center p-4 min-h-[500px] animate-pulse">
                        <div class="text-center">
                            <i class="fas fa-lock text-6xl text-gray-500 mb-4"></i>
                            <h3 class="text-3xl font-bold mb-2 text-yellow-500">Pr√≥ximamente</h3>
                            <p class="text-gray-400">Nuevo contenido disponible la pr√≥xima semana.</p>
                        </div>
                    </div>`;
            }
            
            const starIcon = '<i class="fas fa-hand-pointer text-cyan-400"></i>';
            const defaultImage = song.image || 'imagenportada/default.png'; 
            const badgeClass = isTop3 ? (position === 1 ? 'bg-purple-600' : (position === 2 ? 'bg-gray-400' : 'bg-amber-700')) : 'bg-purple-600';
            const diamondIcon = song.hasDiamond ? '<span class="ml-2 text-xl align-middle" title="¬°Quiz Perfecto!">üíé</span>' : '';
            
            const quizStarsBadge = (song.quizStars && song.quizStars > 0) ? `
                <div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full shadow-lg flex items-center gap-1 z-10">
                    <span>${song.quizStars}</span><i class="fas fa-star text-xs"></i>
                </div>` : '';

            const quizButton = !song.unlocked ? `<button onclick="openQuizModal(${song.id})" class="mt-2 w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg font-bold">HACER QUIZ</button>` : '';
            
            // ** L√ìGICA DE SELECCI√ìN ACTUALIZADA **
            const isSelected = getGlobalSelectedSongs().some(s => s.room === ROOM_IDENTIFIER && s.id === song.id);
            const selectButtonClass = song.listened ? (isSelected ? 'bg-gray-500 cursor-not-allowed' : 'bg-pink-600 hover:bg-pink-700') : 'bg-gray-500 cursor-not-allowed';
            const selectButtonAction = song.listened && !isSelected ? `onclick="selectSongForProfile(${song.id})"` : 'disabled';
            // ** FIN L√ìGICA DE SELECCI√ìN ACTUALIZADA **

            return `
                <div class="bg-gray-800 border border-gray-700 rounded-xl overflow-hidden shadow-lg relative flex flex-col">
                    ${quizStarsBadge}
                    <div class="absolute top-0 left-0 ${badgeClass} text-white font-black text-lg p-2 rounded-br-lg z-10">${position}</div>
                    <div class="h-48 w-full bg-cover bg-center" style="background-image: url('${defaultImage}')"></div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-2xl font-bold mb-2 text-yellow-400 flex items-center">${song.title} ${diamondIcon}</h3>
                        
                        <div class="mt-1 mb-4 flex items-center justify-start space-x-4">
                            <button onclick="playAudio(${song.id})" id="playButton${song.id}" class="bg-lime-500 hover:bg-lime-600 text-gray-900 w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all hover:scale-105" title="Escuchar">
                                <i class="fas fa-play text-xl"></i>
                            </button>
                            <button onclick="stopAudio(${song.id})" id="stopButton${song.id}" class="hidden bg-gray-500 hover:bg-gray-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all hover:scale-105" title="Detener">
                                <i class="fas fa-stop text-xl"></i>
                            </button>
                            <span id="listeningText${song.id}" class="text-lime-400 font-semibold hidden">Escuchando...</span>
                        </div>
                        <audio id="audioPlayer${song.id}" src="${song.localAudioUrl}" onended="resetPlayButton(${song.id})" hidden></audio>
                        <p class="text-sm text-gray-400 mb-4">${song.description}</p>
                        <div class="border-t border-purple-700 pt-3 mb-4 space-y-1">
                            <p>Autor: <span class="font-semibold text-lime-400">${song.author}</span></p>
                            <p>A√±o: <span class="font-semibold text-cyan-400">${song.year}</span></p>
                            <p>G√©nero: <span class="font-semibold text-cyan-400">${song.genre}</span></p>
                            ${quizButton}
                        </div>
                        <div class="mt-auto pt-3 border-t border-purple-700 flex items-center justify-between">
                            <div class="flex items-center space-x-1 text-yellow-400 font-bold text-lg">${starIcon}<span>${song.totalStars}</span></div>
                            <div class="flex items-center space-x-2">
                                <button onclick="openVoteSelectionModal(${song.id})" class="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg font-bold">Votar</button>
                                <button ${selectButtonAction} class="${selectButtonClass} px-3 py-2 rounded-lg font-bold text-sm">${isSelected ? 'Elegida' : 'Elegir'}</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        
        function updateHeaderDisplays() {
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            document.getElementById('userStarsDisplay').textContent = userStars;
            document.getElementById('totalDiamondsDisplay').textContent = totalDiamonds;
            if (document.getElementById('currentVotesRemaining')) {
                document.getElementById('currentVotesRemaining').textContent = votesRemaining;
            }
            if (document.getElementById('currentUserStars')) {
                document.getElementById('currentUserStars').textContent = userStars;
            }
        }

        function renderRanking() {
            songs.sort((a, b) => b.totalStars - a.totalStars);
            const top3 = document.getElementById('top3Container');
            const ranking = document.getElementById('rankingContainer');
            top3.innerHTML = '';
            ranking.innerHTML = '';
            
            const regularSongs = songs.filter(s => !s.comingSoon);
            const comingSoonSongs = songs.filter(s => s.comingSoon);
            
            regularSongs.slice(0, 3).forEach((s, i) => top3.innerHTML += createSongCard(s, i + 1, true));
            regularSongs.slice(3).forEach((s, i) => ranking.innerHTML += createSongCard(s, i + 4, false));
            
            comingSoonSongs.forEach(s => ranking.innerHTML += createSongCard(s));
        }

        window.onload = function() {
            loadAppData();
            renderRanking();
        };
        
        function openGlobalInfoModal() { 
             alert("Mec√°nica de Votaci√≥n:\n\n* Cada usuario dispone de 5 votos semanales.\n* El voto se realiza gastando 5, 6, 7, 8, 9 o 10 estrellas.\n* Solo se puede votar con una cantidad igual o menor a las estrellas acumuladas.\n\nMec√°nica de Quiz y Estrellas:\n\n* **Moneda (Estrellas):** Se ganan **5 estrellas** por cada pregunta acertada.\n* **Bonificaci√≥n:** Se ganan **10 estrellas m√°s de bonificaci√≥n** si aciertas las 5 preguntas.\n* **Diamante üíé:** Se gana un **diamante para esa canci√≥n** al contestar todas las preguntas (las 5) bien."); 
        }
    </script>
</body>


</html>





<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala 1 - Literatura Musical</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @keyframes pulse-custom { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.3; } }
        @keyframes bounce-custom { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes blink-custom { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-custom { animation: pulse-custom 3s ease-in-out infinite; }
        .animate-bounce-custom { animation: bounce-custom 2s ease-in-out infinite; }
        .animate-blink-custom { animation: blink-custom 1s step-start infinite; }
        @keyframes bounce-sala1 { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-bounce-sala1 { animation: bounce-sala1 1.5s ease-in-out infinite; }
        .hidden { display: none; }
        .image-placeholder { background-color: #1f2937; display: flex; align-items: center; justify-content: center; color: #4b5563; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">
    
    <header class="bg-indigo-950 p-4 shadow-xl sticky top-0 z-10 border-b border-indigo-800">
        <div class="container mx-auto flex flex-col items-center">
            
            <h1 class="text-xl md:text-3xl font-extrabold text-teal-400 flex items-center justify-center w-full mb-2">
                <svg class="w-6 h-6 md:w-8 md:h-8 mr-2 text-yellow-400 animate-bounce-sala1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-8z"/>
                </svg>
                Sala literaria
            </h1>
            
            <div class="w-full flex justify-between items-center mb-2 md:mb-4">
                 <div class="flex items-center space-x-4 text-sm md:text-lg font-bold text-white">
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-hand-pointer text-cyan-400 text-lg"></i>
                        <span id="votesRemainingDisplay" class="text-yellow-400">5</span>
                    </div>
                    <span class="text-cyan-400 hidden sm:inline-block">|</span>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-star text-yellow-400 text-lg"></i>
                        <span id="userStarsDisplay" class="text-yellow-400">0</span>
                    </div>
                    <span class="text-cyan-400 hidden sm:inline-block">|</span>
                    <div class="flex items-center space-x-1">
                        <i class="fas fa-gem text-teal-400 text-lg"></i>
                        <span id="totalDiamondsDisplay" class="text-yellow-400">0</span>
                    </div>
                 </div>
                 <div class="flex items-center space-x-2 md:space-x-4">
                    <button onclick="openGlobalInfoModal()" class="bg-indigo-700 hover:bg-indigo-600 p-2 rounded-full transition-all hover:scale-105">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                    <a href="perfil.html" class="bg-emerald-600 hover:bg-emerald-700 p-2 rounded-full transition-all hover:scale-105" title="Ir a Perfil">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </a>
                </div>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-4 w-full justify-center">
                <a href="temas.html" class="bg-purple-600 hover:bg-purple-700 py-2 px-3 rounded-lg font-bold transition-all text-sm md:text-base hover:scale-105">Volver a Temas</a>
            </div>
            
            <p class="text-center text-lg md:text-xl font-medium text-cyan-300 mt-4 px-4">
                Elije 5 canciones que mas te guste para competir por el tercer, segundo y primer puesto.
            </p>
        </div>
    </header>
    
    <main class="container mx-auto p-6">
        <section class="mb-12">
            <h2 class="text-4xl font-extrabold text-center mb-8  text-yellow-400 drop-shadow-lg">üèÜ Top 3: Lo m√°s votado üèÜ</h2>
            <div id="top3Container" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
        </section>
        <section>
            <h2 class="text-3xl font-bold text-center mb-8 text-teal-400">Resto del Ranking</h2>
            <div id="rankingContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
    </main>

    <div id="quizModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-red-900 rounded-2xl max-w-xl w-full max-h-[90vh] overflow-y-auto border-2 border-red-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-red-400" id="quizTitle">Quiz de la Obra</h2>
                <button onclick="closeQuizModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="quizContent" class="p-6 text-white space-y-6">
                </div>
        </div>
    </div>
    
    <div id="voteModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-indigo-900 to-emerald-900 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto border-2 border-emerald-400 shadow-2xl">
            <div class="sticky top-0 bg-indigo-900 p-4 flex justify-between items-center border-b border-indigo-700">
                <h2 class="text-2xl font-bold text-emerald-400" id="voteTitle">Votar por Obra</h2>
                <button onclick="closeVoteSelectionModal()" class="hover:bg-indigo-700 p-2 rounded-full transition text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 text-white space-y-4">
                <p class="text-lg text-center font-semibold mb-4">Selecciona cu√°ntas estrellas ‚≠ê quieres usar para votar por: <span id="songTitleForVote" class="text-yellow-400 font-bold"></span></p>
                <p class="text-sm text-center text-gray-300">Votos restantes: <span id="currentVotesRemaining" class="text-yellow-400 font-bold">5</span> | Estrellas actuales: <span id="currentUserStars" class="text-yellow-400 font-bold">0</span></p>
                
                <div class="grid grid-cols-2 gap-3" id="starOptionsContainer">
                    </div>
                
                <div id="voteMessage" class="mt-4 text-center text-red-400 font-semibold hidden"></div>

                <div class="flex justify-end pt-4">
                    <button onclick="submitVote()" id="submitVoteButton" class="bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-lg font-bold text-lg disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                        Confirmar Voto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-indigo-950 p-4 shadow-inner mt-12 border-t border-indigo-800">
        <div class="container mx-auto flex justify-center items-center">
            <a href="https://youtube.com/@laliteraturamusical?si=hHIjTjWCnq2Y3yyB" target="_blank" class="text-red-400 hover:text-red-500 font-semibold flex items-center gap-2 transition-all">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.64-1.34-7.28-1.34-10.92 0C4.372 4.524 2.82 6.84 2.11 9.47 1.4 12.1 1.4 14.9 2.11 17.53c.71 2.63 2.262 4.946 6.585 6.286 3.64 1.34 7.28 1.34 10.92 0 4.323-1.34 5.875-3.656 6.585-6.286.71-2.63.71-5.43 0-8.06-.71-2.63-2.262-4.946-6.585-6.286zM10 16.5v-9l6 4.5-6 4.5z"></path></svg>
                Visita nuestro canal en YouTube
            </a>
        </div>
    </footer>

    <script>
        var initialSongs = [
            { id: 1, title: "Veinte Poemas de Amor", author: "Pablo Neruda", year: 1924, genre: "Poes√≠a L√≠rica", image: "imagenportada/poemas.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/poemas.aac", description: "Adaptaci√≥n musical de los ic√≥nicos versos de amor de Neruda...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øQu√© elemento se menciona como suficiente para la libertad del poeta?", a: "Mis alas", d: ["Tu pecho", "La noche", "El cielo"] }, { q: "¬øQu√© ha sembrado la ausencia de la amada en la casa?", a: "Dudas", d: ["Soledad", "Luz", "Alegr√≠a"] }, { q: "¬øQu√© parte del cuerpo de la amada se queda con el poeta?", a: "Su cuerpo", d: ["Su alma", "Su voz", "Su coraz√≥n"] }, { q: "¬øQu√© sube hasta el cielo desde la boca del poeta?", a: "Lo dormido sobre tu alma", d: ["Su amor", "Un ave", "Un silencio"] }, { q: "¬øQu√© hora describe el poeta como 'dura y fr√≠a'?", a: "La hora de la partida", d: ["El crep√∫sculo", "El amanecer", "El mediod√≠a"] } ] } },
            { id: 2, title: "Romancero Gitano", author: "Federico Garc√≠a Lorca", year: 1928, genre: "Poes√≠a L√≠rica", image: "imagenportada/romancero.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/romanceroluna.aac", description: "La pasi√≥n flamenca de Lorca convertida en una experiencia musical...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øQui√©n llega a la fragua?", a: "La luna", d: ["El gitano", "Un caballo", "El herrero"] }, { q: "¬øCon qu√© prenda se adorna la luna?", a: "Su polis√≥n de nardos", d: ["Vestido de seda", "Flores blancas", "Falda de encaje"] }, { q: "¬øQu√© le ense√±a la luna al ni√±o?", a: "Sus senos de duro esta√±o", d: ["Una navaja", "Un tesoro", "Su sonrisa"] }, { q: "¬øC√≥mo se describe la luna mientras mueve sus brazos?", a: "L√∫brica y pura", d: ["P√°lida y fr√≠a", "Grande y redonda", "Roja y sangrienta"] }, { q: "¬øQui√©n mira fijamente a la luna?", a: "El ni√±o", d: ["La madre", "El gitano", "El fuego"] } ] } },
            { id: 3, title: "Canci√≥n del Pirata", author: "Jos√© de Espronceda", year: 1840, genre: "Poes√≠a L√≠rica", image: "imagenportada/cancionpirata.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/cancionpirata.aac", description: "La libertad y aventura del romanticismo espa√±ol en una composici√≥n...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øCon cu√°ntos ca√±ones navega el bergant√≠n?", a: "Diez", d: ["Ocho", "Doce", "Catorce"] }, { q: "¬øQu√© hace la nave en lugar de 'cortar el mar'?", a: "Vuela", d: ["Flota", "Se hunde", "Navega lento"] }, { q: "¬øCu√°l es el nombre del bajel pirata?", a: "El Temido", d: ["El Valiente", "El Audaz", "El Veloz"] }, { q: "¬øQu√© elemento le da velocidad a la nave?", a: "Viento en popa", d: ["Remos fuertes", "M√°quinas de vapor", "Corrientes marinas"] }, { q: "¬øDe d√≥nde a d√≥nde es conocido el bajel?", a: "Del uno al otro conf√≠n", d: ["De puerto a puerto", "En el Mediterr√°neo", "En todos los mares"] } ] } },
            { id: 4, title: "Campos de Castilla (Retrato)", author: "Antonio Machado", year: 1912, genre: "Poes√≠a L√≠rica", image: "imagenportada/campos.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/camposretrato.aac", description: "Los paisajes castellanos de Machado cobran vida en una melod√≠a...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øQu√© recuerda el poeta de su infancia en Sevilla?", a: "Un patio", d: ["Una plaza", "Una casa", "Un r√≠o"] }, { q: "¬øQu√© fruto madura en el huerto de su infancia?", a: "El limonero", d: ["El naranjo", "El manzano", "El almendro"] }, { q: "¬øCu√°ntos a√±os de su vida vivi√≥ en Castilla?", a: "Veinte a√±os", d: ["Diez a√±os", "Toda su vida", "Cinco a√±os"] }, { q: "¬øC√≥mo describe el poeta al huerto de su infancia?", a: "Claro", d: ["Sombr√≠o", "Seco", "Grande"] }, { q: "¬øQu√© parte de su vida prefiere no recordar?", a: "Algunos casos de su historia", d: ["Sus amores", "Su tristeza", "Su exilio"] } ] } },
            { id: 5, title: "Altazor (Canto IV)", author: "Vicente Huidobro", year: 1931, genre: "Poes√≠a Vanguardista", image: "imagenportada/altazor.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/altazorcanto4.aac", description: "La vanguardia po√©tica transformada en una experiencia sonora...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øQu√© parte del cuerpo humano corta la vida del instante?", a: "Las manos", d: ["Los ojos", "La boca", "Los pies"] }, { q: "¬øA d√≥nde propone el poeta ir a cortar la vida del instante?", a: "A la luna o al sol", d: ["Al pasado", "Al futuro", "A la tierra"] }, { q: "¬øQu√© se abre en las manos del hombre?", a: "La vida del instante", d: ["Un libro", "Un paraca√≠das", "Un abismo"] }, { q: "¬øCu√°l es la frase que subraya la urgencia al inicio del fragmento?", a: "No hay tiempo que perder.", d: ["Vamos donde sea.", "El instante se abre.", "Las manos cortan."] }, { q: "¬øQu√© concepto principal del Vanguardismo ilustra este fragmento?", a: "El poeta como Dios (Creacionismo)", d: ["El amor rom√°ntico", "La cr√≠tica social", "El realismo m√°gico"] } ] } },
            { id: 6, title: "Trilce", author: "C√©sar Vallejo", year: 1922, genre: "Poes√≠a Vanguardista", image: "imagenportada/trilce.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/trilce.aac", description: "La innovaci√≥n ling√º√≠stica de Vallejo encuentra su expresi√≥n...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øQu√© no deja hacer la bulla seg√∫n el poema?", a: "Testar las √∫nicas herencias", d: ["Dormir", "Hablar", "Escribir"] }, { q: "¬øQu√© se hace de una simple trenza?", a: "Toda una madeja", d: ["Una cuerda", "Un nudo", "Un ovillo"] }, { q: "¬øD√≥nde se localiza el hambre mencionada?", a: "En el vientre del cielo", d: ["En el est√≥mago", "En la tierra", "En el poeta"] }, { q: "¬øQu√© pide el poeta que no se le da 'D√≠a y noche'?", a: "Un respiro, un desvelo", d: ["Silencio", "Comida", "Consuelo"] }, { q: "¬øQu√© palabra inusual usa Vallejo para hablar de la 'herencia'?", a: "Testar", d: ["Recibir", "Declarar", "Dejar"] } ] } },
            { id: 7, title: "La Voz a Ti Debida", author: "Pedro Salinas", year: 1933, genre: "Poes√≠a L√≠rica", image: "imagenportada/lavoz.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/lavoz.aac", description: "El amor puro de Salinas convertido en una balada contempor√°nea...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øD√≥nde vive el ser amado seg√∫n el poeta?", a: "En sus actos", d: ["En su memoria", "En su coraz√≥n", "En el cielo"] }, { q: "¬øQu√© baja junto con la muerte?", a: "El tel√≥n", d: ["La lluvia", "La noche", "La cortina"] }, { q: "¬øC√≥mo describe el poeta a la vida sin el ser amado?", a: "Su forma m√°s triste", d: ["Su forma m√°s pura", "Su forma m√°s solitaria", "Su forma m√°s libre"] }, { q: "¬øCu√°l es la forma m√°s triste de la vida?", a: "De recuerdo", d: ["De esperanza", "De vac√≠o", "De olvido"] }, { q: "¬øQu√© contin√∫a existiendo bajo el tel√≥n de la muerte?", a: "La vida", d: ["El silencio", "La nada", "El amor"] } ] } },
            { id: 8, title: "Residencia en la Tierra (Barcarola)", author: "Pablo Neruda", year: 1935, genre: "Poes√≠a Surrealista", image: "imagenportada/residencia.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/residenciabarcarola.aac", description: "La angustia existencial nerudiana transmutada en composiciones...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øQu√© pide el poeta que se le d√© solamente?", a: "La noche, la noche oscura", d: ["La lluvia y el viento", "Un barco", "Un silencio profundo"] }, { q: "¬øQu√© m√°s pide que se le d√© junto a la noche?", a: "El mar con sus olas furiosas", d: ["La tierra y el fuego", "Una estrella", "Un recuerdo"] }, { q: "¬øQu√© afirma el poeta que ser√≠a si se le dieran esas cosas?", a: "Feliz", d: ["Triste", "Fuerte", "Dichoso"] }, { q: "¬øQu√© se le da al poeta que no desea en su lugar?", a: "La luz, la luna y el sol, y el tiempo", d: ["El dinero", "El amor", "La juventud"] }, { q: "¬øQu√© tipo de emoci√≥n predomina en el deseo del fragmento?", a: "Angustia y deseo de oscuridad", d: ["Alegr√≠a", "Nostalgia", "Indiferencia"] } ] } },
            { id: 9, title: "Poeta en Nueva York (La aurora)", author: "Federico Garc√≠a Lorca", year: 1940, genre: "Poes√≠a Surrealista", image: "imagenportada/poeta.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/poetaaurora.aac", description: "El surrealismo urbano de Lorca en la gran manzana, ahora en ritmos...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øQu√© es lo que asesina al poeta, seg√∫n el primer verso?", a: "El cielo", d: ["La ciudad", "El tiempo", "El miedo"] }, { q: "¬øQu√© formas buscan el cristal?", a: "Las formas", d: ["Las manos", "Las palabras", "Las sombras"] }, { q: "¬øQu√© dejar√° crecer el poeta?", a: "Sus cabellos y sus u√±as", d: ["Sus plantas", "Sus deudas", "Sus ideas"] }, { q: "¬øCon qu√© ir√° el poeta al mar?", a: "Con el traje roto, y el coraz√≥n destrozado", d: ["Con traje nuevo", "Con su familia", "En barco"] }, { q: "¬øHacia qu√© animal van las formas?", a: "Hacia la sierpe", d: ["Hacia el √°guila", "Hacia el le√≥n", "Hacia el delf√≠n"] } ] } },
            { id: 10, title: "Marinero en Tierra", author: "Rafael Alberti", year: 1925, genre: "Poes√≠a L√≠rica", image: "imagenportada/marinero.png", totalStars: 0, quizStars: 0, localAudioUrl: "audio/marinerotierra.aac", description: "La nostalgia marinera de Alberti navega en melod√≠as que evocan...", unlocked: false, listened: false, hasDiamond: false, contentQuizData: { questions: [ { q: "¬øEn qu√© est√° navegando el marinero de la ribera?", a: "Sin mar y sin nav√≠o", d: ["En un barco peque√±o", "En un r√≠o", "En un estanque"] }, { q: "¬øSobre qu√© camina el marinero en la ribera?", a: "Sobre el sol y el fr√≠o de la sed y el recuerdo", d: ["Sobre la arena", "Sobre las olas", "Sobre la cubierta"] }, { q: "¬øQu√© dar√≠a el poeta por el mar de la ma√±ana?", a: "La orilla de la tierra", d: ["Un diamante", "Todas sus estrellas", "Un abrazo"] }, { q: "¬øQu√© dar√≠a el poeta por la sombra de una barca?", a: "Esta llanura yerma", d: ["Su casa", "Su nombre", "Su libertad"] }, { q: "¬øDe qu√© sufre el marinero en la ribera?", a: "De la sed y el recuerdo", d: ["De calor", "De hambre", "De sue√±o"] } ] } }
        ];

        var songs = []; 
        var votesRemaining = 5; 
        var userStars = 0; 
        var totalDiamonds = 0;
        var selectedSongId = null; 
        var selectedSongIdForVote = null; 
        var selectedStarsForVote = 0; 
        var selectedSongs = [];
        // Valores de votaci√≥n permitidos
        const VOTE_AMOUNTS = [5, 6, 7, 8, 9, 10]; 
        
        // Variable para manejar la reproducci√≥n de un solo audio
        let currentlyPlayingAudio = null;

        function saveAppData() {
            localStorage.setItem('literatura_songs', JSON.stringify(songs));
            localStorage.setItem('literatura_votesRemaining', votesRemaining); 
            localStorage.setItem('literatura_userStars', userStars); 
            localStorage.setItem('literatura_totalDiamonds', totalDiamonds);
            localStorage.setItem('literatura_selectedSongs', JSON.stringify(selectedSongs));
        }

        function loadAppData() {
            const savedSongs = localStorage.getItem('literatura_songs');
            songs = savedSongs ? JSON.parse(savedSongs) : initialSongs;
            votesRemaining = parseInt(localStorage.getItem('literatura_votesRemaining') || '5');
            userStars = parseInt(localStorage.getItem('literatura_userStars') || '0');
            totalDiamonds = parseInt(localStorage.getItem('literatura_totalDiamonds') || '0');
            selectedSongs = JSON.parse(localStorage.getItem('literatura_selectedSongs') || '[]');

            let diamondRecount = 0;
            songs = songs.map(song => {
                const initial = initialSongs.find(s => s.id === song.id);
                if (typeof song.quizStars === 'undefined') song.quizStars = 0;
                if (song.hasDiamond) diamondRecount++;
                if (initial) song.contentQuizData = initial.contentQuizData;
                return song;
            });

            if (totalDiamonds !== diamondRecount) totalDiamonds = diamondRecount;
            updateHeaderDisplays();
        }
        
        function selectSongForProfile(songId) {
            const song = songs.find(s => s.id === songId);
            if (!song || !song.listened || selectedSongs.length >= 5 || selectedSongs.some(s => s.id === songId)) {
                if(!song.listened) alert("Debes escuchar la canci√≥n antes de elegirla.");
                return;
            }
            
            selectedSongs.push({
                id: song.id, title: song.title, author: song.author, image: song.image,
                hasDiamond: song.hasDiamond, quizStars: song.quizStars || 0
            });
            
            saveAppData();
            renderRanking();
            alert(`¬°"${song.title}" ha sido elegida para tu perfil!`);
        }
        
        // --- FUNCIONES DEL QUIZ ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateQuizQuestions(song) {
            if (!song.contentQuizData || !song.contentQuizData.questions || song.contentQuizData.questions.length < 5) {
                return '<p class="text-red-400">Error: No hay suficientes preguntas para esta obra.</p>';
            }
            
            const selectedQuestions = shuffleArray([...song.contentQuizData.questions]).slice(0, 5);
            let quizHtml = '';
            selectedQuestions.forEach((qData, index) => {
                const qNum = index + 1;
                const options = shuffleArray([qData.a, ...qData.d]);
                const optionsHtml = options.map(opt => `
                    <label class="flex items-center p-3 bg-indigo-700/50 rounded-lg hover:bg-indigo-600 cursor-pointer">
                        <input type="radio" name="question${qNum}" value="${opt}" class="form-radio h-5 w-5 text-red-400">
                        <span class="ml-3 text-lg">${opt}</span>
                    </label>
                `).join('');

                quizHtml += `
                    <div class="p-4 bg-indigo-800 rounded-xl border border-indigo-600" data-q-original="${qData.q}" data-q-correct="${qData.a}">
                        <p class="text-xl font-semibold mb-4 text-yellow-300">Pregunta ${qNum}: ${qData.q}</p>
                        <div class="space-y-2">${optionsHtml}</div>
                        <input type="hidden" id="correctAnswer${qNum}" value="${qData.a}">
                    </div>
                `;
            });
            return quizHtml;
        }

        function openQuizModal(id){
            selectedSongId = id;
            const song = songs.find(s => s.id === id);
            if (!song) return;

            document.getElementById('quizTitle').textContent = `Quiz: ¬øQu√© sabes de "${song.title}"?`;
            const quizContent = document.getElementById('quizContent');
            quizContent.innerHTML = generateQuizQuestions(song) + `
                <div class="flex justify-end pt-6">
                    <button onclick="submitQuiz()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-bold text-lg">
                        Finalizar Quiz
                    </button>
                </div>
            `;
            document.getElementById('quizModal').classList.remove('hidden');
        }

        function closeQuizModal() {
            document.getElementById('quizModal').classList.add('hidden');
            selectedSongId = null;
        }

        function submitQuiz() {
            const songIndex = songs.findIndex(s => s.id === selectedSongId);
            if (songIndex === -1) return;

            let correctAnswers = 0;
            const totalQuestions = 5;
            let resultDetailsHtml = '';

            for (let i = 1; i <= totalQuestions; i++) {
                const questionDiv = document.querySelector(`#quizContent > div:nth-child(${i})`);
                if (!questionDiv) continue;
                
                const questionText = questionDiv.getAttribute('data-q-original');
                const selectedInput = document.querySelector(`input[name="question${i}"]:checked`);
                const userAnswer = selectedInput ? selectedInput.value : 'No contestada';
                const correctAnswer = questionDiv.getAttribute('data-q-correct');
                const isCorrect = userAnswer === correctAnswer;
                
                if (isCorrect) correctAnswers++;

                // Generar el detalle del resultado
                resultDetailsHtml += `
                    <div class="p-3 rounded-lg border ${isCorrect ? 'border-green-500 bg-green-900/50' : 'border-red-500 bg-red-900/50'}">
                        <p class="font-bold text-lg mb-1 text-yellow-300">P. ${i}: ${questionText}</p>
                        <p class="text-sm">Tu Respuesta: <span class="${isCorrect ? 'text-green-300' : 'text-red-300 font-bold'}">${userAnswer} ${isCorrect ? '‚úÖ' : '‚ùå'}</span></p>
                        ${!isCorrect ? `<p class="text-sm">Correcta: <span class="text-cyan-300 font-bold">${correctAnswer}</span></p>` : ''}
                    </div>
                `;
            }

            let starsGained = correctAnswers * 5;
            let diamondGained = false;
            let resultMessage = '';

            if (correctAnswers === totalQuestions) {
                starsGained += 10; // Bonus
                if (!songs[songIndex].hasDiamond) {
                    songs[songIndex].hasDiamond = true;
                    totalDiamonds++;
                    diamondGained = true;
                }
                // Mensaje del diamante: "al contestar todas bi√©n"
                resultMessage = `<p class="font-bold text-yellow-300 mt-2 text-xl">¬°PERFECTO! +10 Estrellas de bonificaci√≥n. ¬°Al contestar todas bi√©n, has ganado un üíé!</p>`;
            } else {
                 resultMessage = `<p class="font-bold text-yellow-300 mt-2">¬°Sigue practicando! Puedes mejorar tu puntaje.</p>`;
            }

            songs[songIndex].quizStars = starsGained;
            userStars += starsGained;
            songs[songIndex].unlocked = true; 
            
            // Mostrar resultado en el modal
            const quizContent = document.getElementById('quizContent');
            quizContent.innerHTML = `
                <div class="text-center p-6 bg-indigo-700 rounded-xl mb-4">
                    <h3 class="text-3xl font-bold mb-4">¬°Resultado!</h3>
                    <p class="text-2xl font-semibold text-cyan-400">Respuestas Correctas: ${correctAnswers} de ${totalQuestions}</p>
                    <p class="text-xl mt-4 text-yellow-400">Estrellas ganadas: <span class="font-bold text-3xl">${starsGained}</span> ‚≠ê</p>
                    ${resultMessage}
                </div>
                <h4 class="text-2xl font-bold text-teal-400 mb-3 border-b border-teal-400 pb-2">Detalle de Respuestas</h4>
                <div class="space-y-3">${resultDetailsHtml}</div>
                <div class="flex justify-end pt-4">
                    <button onclick="closeQuizModal()" class="bg-indigo-500 hover:bg-indigo-600 px-6 py-3 rounded-lg font-bold text-lg">Cerrar</button>
                </div>
            `;

            saveAppData();
            renderRanking();
            updateHeaderDisplays();
        }
        
        // --- FUNCIONES DE AUDIO CAMUFLADO ---

        function playAudio(songId) {
            const audioPlayer = document.getElementById(`audioPlayer${songId}`);
            
            if (!audioPlayer) return;

            if (audioPlayer.paused) {
                // Pausar el audio que se est√© reproduciendo actualmente
                if (currentlyPlayingAudio && currentlyPlayingAudio !== audioPlayer) {
                    currentlyPlayingAudio.pause();
                    const previousId = parseInt(currentlyPlayingAudio.id.replace('audioPlayer', ''));
                    resetPlayButton(previousId);
                }

                // Reproducir el audio seleccionado
                audioPlayer.play().catch(error => {
                    // Manejar error de reproducci√≥n (a menudo causado por pol√≠ticas de autoplay)
                    console.error("Error al intentar reproducir audio:", error);
                                       resetPlayButton(songId); 
                });
                
                markAsListened(songId); // Marcar como escuchado inmediatamente
                updatePlayButton(songId, true);
                currentlyPlayingAudio = audioPlayer;

            } else {
                // Pausar si ya est√° reproduciendo
                audioPlayer.pause();
                updatePlayButton(songId, false);
                currentlyPlayingAudio = null;
            }
        }
        
        function updatePlayButton(songId, isPlaying) {
             const playButton = document.getElementById(`playButton${songId}`);
             const listeningText = document.getElementById(`listeningText${songId}`);
             
             if (playButton && listeningText) {
                 if (isPlaying) {
                    playButton.innerHTML = '<i class="fas fa-pause text-xl"></i>';
                    listeningText.classList.remove('hidden');
                 } else {
                    playButton.innerHTML = '<i class="fas fa-play text-xl"></i>';
                    listeningText.classList.add('hidden');
                 }
             }
        }

        function resetPlayButton(songId) {
             // Esta funci√≥n es llamada cuando el audio termina (onended) o si hay un error de reproducci√≥n
             updatePlayButton(songId, false);
             if (currentlyPlayingAudio && currentlyPlayingAudio.id === `audioPlayer${songId}`) {
                 currentlyPlayingAudio = null;
             }
             renderRanking(); // Vuelve a renderizar para actualizar el estado del bot√≥n "Elegir"
        }

        function markAsListened(songId) {
            const song = songs.find(s => s.id === songId);
            if(song && !song.listened) {
                song.listened = true;
                saveAppData();
            }
        }
        
        // --- FIN FUNCIONES DE AUDIO CAMUFLADO ---


        // --- FUNCIONES DE VOTO ---

        function openVoteSelectionModal(id) {
            selectedSongIdForVote = id;
            selectedStarsForVote = 0;
            const song = songs.find(s => s.id === id);
            if (!song) return;

            document.getElementById('songTitleForVote').textContent = `"${song.title}"`;
            document.getElementById('currentVotesRemaining').textContent = votesRemaining;
            document.getElementById('currentUserStars').textContent = userStars;
            document.getElementById('voteMessage').classList.add('hidden');
            document.getElementById('submitVoteButton').disabled = true;

            const starOptionsContainer = document.getElementById('starOptionsContainer');
            starOptionsContainer.innerHTML = '';

            VOTE_AMOUNTS.forEach(stars => {
                const canAfford = userStars >= stars;
                const disabledClass = !canAfford ? 'bg-gray-700/50 cursor-not-allowed opacity-50' : 'bg-emerald-700/50 hover:bg-emerald-600 cursor-pointer';
                const label = document.createElement('label');
                label.className = `flex items-center justify-center p-3 rounded-lg transition-all border border-emerald-500 ${disabledClass}`;
                label.innerHTML = `
                    <input type="radio" name="voteStars" value="${stars}" class="hidden" onchange="handleStarSelection(${stars})" ${!canAfford ? 'disabled' : ''}>
                    <span class="text-xl font-bold flex items-center">
                        ${stars} <i class="fas fa-star ml-2 text-yellow-400"></i>
                    </span>
                `;
                starOptionsContainer.appendChild(label);
            });

            document.getElementById('voteModal').classList.remove('hidden');
        }

        function closeVoteSelectionModal() {
            document.getElementById('voteModal').classList.add('hidden');
            selectedSongIdForVote = null;
            selectedStarsForVote = 0;
        }

        function handleStarSelection(stars) {
            selectedStarsForVote = stars;
            const submitButton = document.getElementById('submitVoteButton');
            const message = document.getElementById('voteMessage');

            if (votesRemaining <= 0) {
                message.textContent = "No tienes votos restantes.";
                message.classList.remove('hidden');
                submitButton.disabled = true;
            } else if (userStars < selectedStarsForVote) {
                message.textContent = `Necesitas ${selectedStarsForVote} ‚≠ê para votar con esta opci√≥n.`;
                message.classList.remove('hidden');
                submitButton.disabled = true;
            } else {
                message.classList.add('hidden');
                submitButton.disabled = false;
            }
        }

        function submitVote() {
            if (votesRemaining <= 0) {
                alert("¬°No tienes votos restantes!");
                return;
            }

            if (selectedStarsForVote === 0 || userStars < selectedStarsForVote) {
                alert("Por favor, selecciona una cantidad de estrellas v√°lida para votar.");
                return;
            }

            const songIndex = songs.findIndex(s => s.id === selectedSongIdForVote);
            if (songIndex === -1) return;

            // Aplicar el voto
            votesRemaining--;
            userStars -= selectedStarsForVote;
            songs[songIndex].totalStars += selectedStarsForVote;

            alert(`¬°Voto exitoso! Usaste ${selectedStarsForVote} ‚≠ê para votar por "${songs[songIndex].title}".`);
            
            saveAppData();
            updateHeaderDisplays();
            renderRanking();
            closeVoteSelectionModal();
        }
        
        // --- FIN FUNCIONES DE VOTO ---


        function createSongCard(song, position, isTop3 = false) {
            const starIcon = '<i class="fas fa-star text-yellow-400"></i>';
            const defaultImage = song.image || 'imagenportada/default.png'; 
            const badgeClass = isTop3 ? (position === 1 ? 'bg-indigo-600' : (position === 2 ? 'bg-gray-400' : 'bg-amber-700')) : 'bg-indigo-600';
            const diamondIcon = song.hasDiamond ? '<span class="ml-2 text-xl align-middle" title="¬°Quiz Perfecto!">üíé</span>' : '';
            
            const quizStarsBadge = (song.quizStars && song.quizStars > 0) ? `
                <div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full shadow-lg flex items-center gap-1 z-10">
                    <span>${song.quizStars}</span>
                    <i class="fas fa-star text-xs"></i>
                </div>` : '';

            const quizButton = !song.unlocked ? `<button onclick="openQuizModal(${song.id})" class="mt-2 w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg font-bold">HACER QUIZ</button>` : '';
            const isSelected = selectedSongs.some(s => s.id === song.id);
            const selectButtonClass = song.listened ? (isSelected ? 'bg-gray-500 cursor-not-allowed' : 'bg-pink-600 hover:bg-pink-700') : 'bg-gray-500 cursor-not-allowed';
            const selectButtonAction = song.listened && !isSelected ? `onclick="selectSongForProfile(${song.id})"` : 'disabled';

            return `
                <div class="bg-gray-800 border border-gray-700 rounded-xl overflow-hidden shadow-lg relative flex flex-col">
                    ${quizStarsBadge}
                    <div class="absolute top-0 left-0 ${badgeClass} text-white font-black text-lg p-2 rounded-br-lg z-10">${position}</div>
                    <div class="h-48 w-full bg-cover bg-center" style="background-image: url('${defaultImage}')"></div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-2xl font-bold mb-2 text-yellow-400 flex items-center">${song.title} ${diamondIcon}</h3>
                        
                        <div class="mt-1 mb-4 flex items-center justify-start space-x-4">
                            <button onclick="playAudio(${song.id})" id="playButton${song.id}" class="bg-teal-500 hover:bg-teal-600 text-gray-900 w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all hover:scale-105" title="Escuchar">
                                <i class="fas fa-play text-xl"></i>
                            </button>
                            <span id="listeningText${song.id}" class="text-teal-400 font-semibold hidden">Escuchando...</span>
                        </div>
                        <audio id="audioPlayer${song.id}" src="${song.localAudioUrl}" onended="resetPlayButton(${song.id})" hidden></audio>
                        <p class="text-sm text-gray-400 mb-4">${song.description}</p>
                        <div class="border-t border-indigo-700 pt-3 mb-4 space-y-1">
                            <p>Autor: <span class="font-semibold text-teal-400">${song.author}</span></p>
                            <p>A√±o: <span class="font-semibold text-cyan-400">${song.year}</span></p>
                            <p>G√©nero: <span class="font-semibold text-cyan-400">${song.genre}</span></p>
                            ${quizButton}
                        </div>
                        <div class="mt-auto pt-3 border-t border-indigo-700 flex items-center justify-between">
                            <div class="flex items-center space-x-1 text-yellow-400 font-bold text-lg">${starIcon}<span>${song.totalStars}</span></div>
                            <div class="flex items-center space-x-2">
                                <button onclick="openVoteSelectionModal(${song.id})" class="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg font-bold">Votar</button>
                                <button ${selectButtonAction} class="${selectButtonClass} px-3 py-2 rounded-lg font-bold text-sm">${isSelected ? 'Elegida' : 'Elegir'}</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        
        function updateHeaderDisplays() {
            document.getElementById('votesRemainingDisplay').textContent = votesRemaining;
            document.getElementById('userStarsDisplay').textContent = userStars;
            document.getElementById('totalDiamondsDisplay').textContent = totalDiamonds;
            // Actualizar tambi√©n en el modal de votaci√≥n si est√° abierto
            if (document.getElementById('currentVotesRemaining')) {
                document.getElementById('currentVotesRemaining').textContent = votesRemaining;
            }
            if (document.getElementById('currentUserStars')) {
                document.getElementById('currentUserStars').textContent = userStars;
            }
        }

        function renderRanking() {
            songs.sort((a, b) => b.totalStars - a.totalStars);
            const top3 = document.getElementById('top3Container');
            const ranking = document.getElementById('rankingContainer');
            top3.innerHTML = '';
            ranking.innerHTML = '';
            songs.slice(0, 3).forEach((s, i) => top3.innerHTML += createSongCard(s, i + 1, true));
            songs.slice(3).forEach((s, i) => ranking.innerHTML += createSongCard(s, i + 4, false));
        }

        window.onload = function() {
            loadAppData();
            renderRanking();
        };
        
        // Placeholder for functions that might be in other modals
        function openGlobalInfoModal() { 
             alert("Mec√°nica de Votaci√≥n:\n\n* Cada usuario dispone de 5 votos semanales.\n* El voto se realiza gastando 5, 6, 7, 8, 9 o 10 estrellas.\n* Solo se puede votar con una cantidad igual o menor a las estrellas acumuladas.\n\nMec√°nica de Quiz y Estrellas:\n\n* **Moneda (Estrellas):** Se ganan **5 estrellas** por cada pregunta acertada.\n* **Bonificaci√≥n:** Se ganan **10 estrellas m√°s de bonificaci√≥n** si aciertas las 5 preguntas.\n* **Diamante üíé:** Se gana un **diamante para esa canci√≥n** al contestar todas las preguntas (las 5) bien."); 
        }
    </script>
</body>
</html>